<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="史上最完美的Android沉浸式状态导航栏攻略"><meta name="keywords" content="Android,沉浸式,状态栏,导航栏,StatusBar,NavigationBar"><meta name="author" content="dreamgyf"><meta name="copyright" content="dreamgyf"><title>史上最完美的Android沉浸式状态导航栏攻略 | 始终都是梦</title><link rel="shortcut icon" href="/images/avatar.jpeg"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '4.2.1'
} </script><meta name="generator" content="Hexo 4.2.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实际效果"><span class="toc-number">2.</span> <span class="toc-text">实际效果</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#传统三键式导航栏"><span class="toc-number">2.1.</span> <span class="toc-text">传统三键式导航栏</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#全面屏导航条"><span class="toc-number">2.2.</span> <span class="toc-text">全面屏导航条</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#理论分析"><span class="toc-number">3.</span> <span class="toc-text">理论分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#沉浸式状态栏"><span class="toc-number">4.</span> <span class="toc-text">沉浸式状态栏</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#状态栏透明"><span class="toc-number">4.1.</span> <span class="toc-text">状态栏透明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#状态栏文字颜色"><span class="toc-number">4.2.</span> <span class="toc-text">状态栏文字颜色</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#矫正显示区域"><span class="toc-number">4.3.</span> <span class="toc-text">矫正显示区域</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fitsSystemWindows"><span class="toc-number">4.3.1.</span> <span class="toc-text">fitsSystemWindows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取状态栏高度"><span class="toc-number">4.3.2.</span> <span class="toc-text">获取状态栏高度</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#沉浸式导航栏"><span class="toc-number">5.</span> <span class="toc-text">沉浸式导航栏</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#导航栏透明"><span class="toc-number">5.1.</span> <span class="toc-text">导航栏透明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#导航栏按钮或导航条颜色"><span class="toc-number">5.2.</span> <span class="toc-text">导航栏按钮或导航条颜色</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#矫正显示区域-1"><span class="toc-number">5.3.</span> <span class="toc-text">矫正显示区域</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fitsSystemWindows-1"><span class="toc-number">5.3.1.</span> <span class="toc-text">fitsSystemWindows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取导航栏高度"><span class="toc-number">5.3.2.</span> <span class="toc-text">获取导航栏高度</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#底部Dialog适配沉浸式"><span class="toc-number">6.</span> <span class="toc-text">底部Dialog适配沉浸式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#获取导航栏高度-1"><span class="toc-number">6.1.</span> <span class="toc-text">获取导航栏高度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LayoutParams导致的异常"><span class="toc-number">6.2.</span> <span class="toc-text">LayoutParams导致的异常</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#尾声"><span class="toc-number">7.</span> <span class="toc-text">尾声</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/images/avatar.jpeg"></div><div class="author-info__name text-center">dreamgyf</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">40</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">43</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">29</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/images/background.jpeg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">始终都是梦</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">主页</a><a class="site-page" href="/archives">文章</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">史上最完美的Android沉浸式状态导航栏攻略</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-01-07</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/">Android</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/%E6%B2%89%E6%B5%B8%E5%BC%8F/">沉浸式</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/%E7%8A%B6%E6%80%81%E6%A0%8F/">状态栏</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/%E5%AF%BC%E8%88%AA%E6%A0%8F/">导航栏</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/StatusBar/">StatusBar</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/NavigationBar/">NavigationBar</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近我在小破站开发一款新App，叫<strong>高能链</strong>。我是一个完美主义者，所以不管对架构还是UI，我都是比较抠细节的，在状态栏和导航栏沉浸式这一块，我还是踩了挺多坑，费了挺多精力的。这次我将我踩坑，适配各机型总结出来的史上最完美的Android沉浸式状态导航栏攻略分享给大家，大家也可以去 <strong><a href="https://www.upowerchain.com/" target="_blank" rel="noopener">高能链官网</a></strong> 下载体验一下我们的App，实际感受一下沉浸式状态导航栏的效果（登录，实名等账号相关页面由于不是我开发的，就没有适配沉浸式导航栏啦，嘻嘻）</p>
<p><strong>注：此攻略只针对 Android 5.0 及以上机型，即 minSdkVersion &gt;= 21</strong></p>
<h1 id="实际效果"><a href="#实际效果" class="headerlink" title="实际效果"></a>实际效果</h1><p>在开始攻略之前，我们先看看完美的沉浸式状态导航栏效果</p>
<h2 id="传统三键式导航栏"><a href="#传统三键式导航栏" class="headerlink" title="传统三键式导航栏"></a>传统三键式导航栏</h2><p><img src="https://raw.githubusercontent.com/dreamgyf/ImageStorage/master/%E5%8F%B2%E4%B8%8A%E6%9C%80%E5%AE%8C%E7%BE%8E%E7%9A%84Android%E6%B2%89%E6%B5%B8%E5%BC%8F%E7%8A%B6%E6%80%81%E5%AF%BC%E8%88%AA%E6%A0%8F%E6%94%BB%E7%95%A5_%E5%AE%A2%E6%80%81%E5%88%97%E8%A1%A8%E9%A1%B5_%E4%B8%89%E9%94%AE%E5%BC%8F.jpg" alt="客态列表页_三键式"></p>
<p><img src="https://raw.githubusercontent.com/dreamgyf/ImageStorage/master/%E5%8F%B2%E4%B8%8A%E6%9C%80%E5%AE%8C%E7%BE%8E%E7%9A%84Android%E6%B2%89%E6%B5%B8%E5%BC%8F%E7%8A%B6%E6%80%81%E5%AF%BC%E8%88%AA%E6%A0%8F%E6%94%BB%E7%95%A5_%E5%AE%A2%E6%80%81%E8%AF%A6%E6%83%85%E9%A1%B5_%E4%B8%89%E9%94%AE%E5%BC%8F.jpg" alt="客态详情页_三键式"></p>
<h2 id="全面屏导航条"><a href="#全面屏导航条" class="headerlink" title="全面屏导航条"></a>全面屏导航条</h2><p><img src="https://raw.githubusercontent.com/dreamgyf/ImageStorage/master/%E5%8F%B2%E4%B8%8A%E6%9C%80%E5%AE%8C%E7%BE%8E%E7%9A%84Android%E6%B2%89%E6%B5%B8%E5%BC%8F%E7%8A%B6%E6%80%81%E5%AF%BC%E8%88%AA%E6%A0%8F%E6%94%BB%E7%95%A5_%E5%AE%A2%E6%80%81%E5%88%97%E8%A1%A8%E9%A1%B5_%E5%AF%BC%E8%88%AA%E6%9D%A1.jpg" alt="客态列表页_导航条"></p>
<p><img src="https://raw.githubusercontent.com/dreamgyf/ImageStorage/master/%E5%8F%B2%E4%B8%8A%E6%9C%80%E5%AE%8C%E7%BE%8E%E7%9A%84Android%E6%B2%89%E6%B5%B8%E5%BC%8F%E7%8A%B6%E6%80%81%E5%AF%BC%E8%88%AA%E6%A0%8F%E6%94%BB%E7%95%A5_%E5%AE%A2%E6%80%81%E8%AF%A6%E6%83%85%E9%A1%B5_%E5%AF%BC%E8%88%AA%E6%9D%A1.jpg" alt="客态详情页_导航条"></p>
<h1 id="理论分析"><a href="#理论分析" class="headerlink" title="理论分析"></a>理论分析</h1><p>在上具体实现代码之前，我们先分析一下，实现沉浸式状态导航栏需要几步</p>
<ol>
<li><p>状态栏导航栏底色透明</p>
</li>
<li><p>根据当前页面的背景色，给状态栏字体和导航栏按钮（或导航条）设置亮色或暗色</p>
</li>
<li><p>状态栏导航栏设置透明后，我们页面的布局会延伸到原本状态栏导航栏的位置，这时候需要一些手段将我们需要显示的正文内容回缩到其正确的显示范围内</p>
<p> 这里我给大家提供以下几种思路，大家可以根据实际情况自行选择：</p>
<ul>
<li>设置<code>fitsSystemWindows</code>属性</li>
<li>根据状态栏导航栏的高度，给根布局设置相应的<code>paddingTop</code>和<code>paddingBottom</code></li>
<li>根据状态栏导航栏的高度，给需要移位的控件设置相应的<code>marginTop</code>和<code>marginBottom</code></li>
<li>在顶部和底部增加两个占位的<code>View</code>，高度分别设置成状态栏和导航栏的高度</li>
<li>针对滑动视图，巧用<code>clipChildren</code>和<code>clipToPadding</code>属性（可参照高能链藏品详情页样式）</li>
</ul>
</li>
</ol>
<h1 id="沉浸式状态栏"><a href="#沉浸式状态栏" class="headerlink" title="沉浸式状态栏"></a>沉浸式状态栏</h1><p>思路说完了，我们现在开始进入实战，沉浸式状态栏比较简单，没什么坑</p>
<h2 id="状态栏透明"><a href="#状态栏透明" class="headerlink" title="状态栏透明"></a>状态栏透明</h2><p>首先第一步，我们需要将状态栏的背景设置为透明，这里我直接放代码</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">transparentStatusBar</span><span class="params">(window: <span class="type">Window</span>)</span></span> &#123;</span><br><span class="line">    window.clearFlags(WindowManager.LayoutParams.FLAG_TRANSLUCENT_STATUS)</span><br><span class="line">    window.addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS)</span><br><span class="line">    <span class="keyword">var</span> systemUiVisibility = window.decorView.systemUiVisibility</span><br><span class="line">    systemUiVisibility =</span><br><span class="line">        systemUiVisibility or View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN or View.SYSTEM_UI_FLAG_LAYOUT_STABLE</span><br><span class="line">    window.decorView.systemUiVisibility = systemUiVisibility</span><br><span class="line">    window.statusBarColor = Color.TRANSPARENT</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置状态栏文字颜色</span></span><br><span class="line">    setStatusBarTextColor(window, NightMode.isNightMode(window.context))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先，我们需要将<code>FLAG_TRANSLUCENT_STATUS</code>这个<code>windowFlag</code>换成<code>FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS</code>，否则状态栏不会完全透明，会有一个半透明的灰色蒙层</p>
<p><code>FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS</code>这个<code>flag</code>表示系统<code>Bar</code>的背景将交给当前<code>window</code>绘制</p>
<p><code>SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</code>这个<code>flag</code>表示<code>Activity</code>全屏显示，但状态栏不会被隐藏，依然可见</p>
<p><code>SYSTEM_UI_FLAG_LAYOUT_STABLE</code>这个<code>flag</code>表示保持整个<code>View</code>稳定，使<code>View</code>不会因为系统UI的变化而重新<code>layout</code></p>
<p><code>SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</code>和<code>SYSTEM_UI_FLAG_LAYOUT_STABLE</code>这两个<code>flag</code>通常是一起使用的，我们设置这两个<code>flag</code>，然后再将<code>statusBarColor</code>设置为透明，就达成了状态栏背景透明的效果</p>
<h2 id="状态栏文字颜色"><a href="#状态栏文字颜色" class="headerlink" title="状态栏文字颜色"></a>状态栏文字颜色</h2><p>接着我们就该设置状态栏文字颜色了，细心的小伙伴们应该已经注意到了，我在<code>transparentStatusBar</code>方法的末尾加了一个<code>setStatusBarTextColor</code>的方法调用，一般情况下，如果是日间模式，页面背景通常都是亮色，所以此时状态栏文字颜色设置为黑色比较合理，而在夜间模式下，页面背景通常都是暗色，此时状态栏文字颜色设置为白色比较合理，对应代码如下</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setStatusBarTextColor</span><span class="params">(window: <span class="type">Window</span>, light: <span class="type">Boolean</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) &#123;</span><br><span class="line">        <span class="keyword">var</span> systemUiVisibility = window.decorView.systemUiVisibility</span><br><span class="line">        systemUiVisibility = <span class="keyword">if</span> (light) &#123; <span class="comment">//白色文字</span></span><br><span class="line">            systemUiVisibility and View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR.inv()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">//黑色文字</span></span><br><span class="line">            systemUiVisibility or View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR</span><br><span class="line">        &#125;</span><br><span class="line">        window.decorView.systemUiVisibility = systemUiVisibility</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Android 8.0</code>以上才支持导航栏文字颜色的修改，<code>SYSTEM_UI_FLAG_LIGHT_STATUS_BAR</code>这个<code>flag</code>表示亮色状态栏，即黑色状态栏文字，所以如果希望状态栏文字为黑色，就设置这个<code>flag</code>，如果希望状态栏文字为白色，就将这个<code>flag</code>从<code>systemUiVisibility</code>中剔除</p>
<p>可能有小伙伴不太了解<code>kotlin</code>中的位运算，<code>kotlin</code>中的<code>or</code>、<code>and</code>、<code>inv</code>分别对应着或、与、取反运算</p>
<p>所以</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemUiVisibility and View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR.inv()</span><br></pre></td></tr></table></figure>

<p>翻译成<code>java</code>即为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemUiVisibility &amp; ~View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR</span><br></pre></td></tr></table></figure>

<p>在原生系统上，这么设置就可以成功设置状态栏文字颜色，但我发现，在某些系统上，这样设置后的效果是不可预期的，譬如<code>MIUI</code>系统的状态栏文字颜色似乎是根据状态栏背景颜色自适应的，且日间模式和黑夜模式下的自适应策略还略有不同。不过在大多数情况下，它自适应的颜色都是正常的，我们就按照我们希望的结果设置就可以了。</p>
<h2 id="矫正显示区域"><a href="#矫正显示区域" class="headerlink" title="矫正显示区域"></a>矫正显示区域</h2><h3 id="fitsSystemWindows"><a href="#fitsSystemWindows" class="headerlink" title="fitsSystemWindows"></a>fitsSystemWindows</h3><p>矫正状态栏显示区域最简单的办法就是设置<code>fitsSystemWindows</code>属性，设置了该属性的<code>View</code>的所有<code>padding</code>属性都将失效，并且系统会自动为其添加<code>paddingTop</code>（设置了透明状态栏的情况下）和<code>paddingBottom</code>（设置了透明导航栏的情况下）</p>
<p>我个人是不用这种方式的，首先它会覆盖你设置的<code>padding</code>，其次，如果你同时设置了透明状态栏和透明导航栏，这个属性没有办法分开来处理，很不灵活</p>
<h3 id="获取状态栏高度"><a href="#获取状态栏高度" class="headerlink" title="获取状态栏高度"></a>获取状态栏高度</h3><p>除了<code>fitsSystemWindows</code>这种方法外，其他的方法都得依靠获取状态栏高度了，这里直接上代码</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getStatusBarHeight</span><span class="params">(context: <span class="type">Context</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> resId = context.resources.getIdentifier(</span><br><span class="line">        <span class="string">"status_bar_height"</span>, <span class="string">"dimen"</span>, <span class="string">"android"</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> context.resources.getDimensionPixelSize(resId)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>状态栏不像导航栏那样多变，所以直接这样获取高度就可以了，导航栏的高度飘忽不定才是真正的噩梦</p>
<p>这里再给两个设置<code>View</code> <code>margin</code>或<code>padding</code>的工具方法吧，帮助大家快速使用</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">fixStatusBarMargin</span><span class="params">(<span class="keyword">vararg</span> views: <span class="type">View</span>)</span></span> &#123;</span><br><span class="line">    views.forEach &#123; view -&gt;</span><br><span class="line">        (view.layoutParams <span class="keyword">as</span>? ViewGroup.MarginLayoutParams)?.let &#123; lp -&gt;</span><br><span class="line">            lp.topMargin = lp.topMargin + getStatusBarHeight(view.context)</span><br><span class="line">            view.requestLayout()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">paddingByStatusBar</span><span class="params">(view: <span class="type">View</span>)</span></span> &#123;</span><br><span class="line">    view.setPadding(</span><br><span class="line">        view.paddingLeft,</span><br><span class="line">        view.paddingTop + getStatusBarHeight(view.context),</span><br><span class="line">        view.paddingRight,</span><br><span class="line">        view.paddingBottom</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="沉浸式导航栏"><a href="#沉浸式导航栏" class="headerlink" title="沉浸式导航栏"></a>沉浸式导航栏</h1><p>沉浸式导航栏相比沉浸式状态栏坑会多很多，具体原因我们后面再说</p>
<h2 id="导航栏透明"><a href="#导航栏透明" class="headerlink" title="导航栏透明"></a>导航栏透明</h2><p>和沉浸式状态栏一样，第一步我们需要将导航栏的背景设置为透明</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">transparentNavigationBar</span><span class="params">(window: <span class="type">Window</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) &#123;</span><br><span class="line">        window.isNavigationBarContrastEnforced = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    window.clearFlags(WindowManager.LayoutParams.FLAG_TRANSLUCENT_NAVIGATION)</span><br><span class="line">    window.addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS)</span><br><span class="line">    <span class="keyword">var</span> systemUiVisibility = window.decorView.systemUiVisibility</span><br><span class="line">    systemUiVisibility =</span><br><span class="line">        systemUiVisibility or View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION</span><br><span class="line">    window.decorView.systemUiVisibility = systemUiVisibility</span><br><span class="line">    window.navigationBarColor = Color.TRANSPARENT</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置导航栏按钮或导航条颜色</span></span><br><span class="line">    setNavigationBarBtnColor(window, NightMode.isNightMode(window.context))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>Android 10</code>以上，当设置了导航栏栏背景为透明时，<code>isNavigationBarContrastEnforced</code>如果为<code>true</code>，则系统会自动绘制一个半透明背景来提供对比度，所以我们要将这个属性设为<code>false</code></p>
<p>ps：状态栏其实也有对应的属性<code>isStatusBarContrastEnforced</code>，只不过这个属性默认即为<code>false</code>，我们不需要特意去设置</p>
<h2 id="导航栏按钮或导航条颜色"><a href="#导航栏按钮或导航条颜色" class="headerlink" title="导航栏按钮或导航条颜色"></a>导航栏按钮或导航条颜色</h2><p>和设置状态栏文字颜色一样，我这里就不多介绍了</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setNavigationBarBtnColor</span><span class="params">(window: <span class="type">Window</span>, light: <span class="type">Boolean</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">        <span class="keyword">var</span> systemUiVisibility = window.decorView.systemUiVisibility</span><br><span class="line">        systemUiVisibility = <span class="keyword">if</span> (light) &#123; <span class="comment">//白色按钮</span></span><br><span class="line">            systemUiVisibility and View.SYSTEM_UI_FLAG_LIGHT_NAVIGATION_BAR.inv()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">//黑色按钮</span></span><br><span class="line">            systemUiVisibility or View.SYSTEM_UI_FLAG_LIGHT_NAVIGATION_BAR</span><br><span class="line">        &#125;</span><br><span class="line">        window.decorView.systemUiVisibility = systemUiVisibility</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="矫正显示区域-1"><a href="#矫正显示区域-1" class="headerlink" title="矫正显示区域"></a>矫正显示区域</h2><h3 id="fitsSystemWindows-1"><a href="#fitsSystemWindows-1" class="headerlink" title="fitsSystemWindows"></a>fitsSystemWindows</h3><p>和状态栏使用一样，我就不重复说明了</p>
<h3 id="获取导航栏高度"><a href="#获取导航栏高度" class="headerlink" title="获取导航栏高度"></a>获取导航栏高度</h3><p>自从全面屏手势开始流行，导航栏也从原先的三键式，变成了三键式、导航条、全隐藏这三种情况，这三种情况下的高度也是互不相同的</p>
<p>三键式和导航条这两种情况我们都可以通过<code>android.R.dimen.navigation_bar_height</code>这个资源获取到准确高度，但现在很多系统都支持隐藏导航栏的功能，在这种情况下，虽然实际导航栏的高度应该是0，但是通过资源获取到的高度却为三键式或导航条的高度，这就给我们沉浸式导航栏的适配带来了很大困难</p>
<p>经过我的各种尝试，我发现只有一种方式可以准确的获取到当前导航栏的高度，那就是<code>WindowInsets</code>，至于<code>WindowInsets</code>是什么我就不多介绍了，我们直接看代码</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 仅当view attach window后生效</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getRealNavigationBarHeight</span><span class="params">(view: <span class="type">View</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> insets = ViewCompat.getRootWindowInsets(view)</span><br><span class="line">        ?.getInsets(WindowInsetsCompat.Type.navigationBars())</span><br><span class="line">    <span class="comment">//WindowInsets为null则默认通过资源获取高度</span></span><br><span class="line">    <span class="keyword">return</span> insets?.bottom ?: getNavigationBarHeight(view.context)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里需要注意到我在方法上写的注释，只有当<code>View</code>和<code>Window</code> attach 后，才能获得到<code>WindowInsets</code>，否则为<code>null</code>，所以我一开始的想法是先检查<code>View</code>是否 attach 了<code>Window</code>，如果有的话则直接调用<code>getRealNavigationBarHeight</code>方法，如果没有的话，调用<code>View.addOnAttachStateChangeListener</code>方法，当出发<code>attach</code>回调后，再调用<code>getRealNavigationBarHeight</code>方法获取高度</p>
<p>这种方式在大部分情况下运行良好，但在我一次无意中切换了系统夜间模式后发现，获取到的导航栏高度变成了0，并且这还是一个偶现的问题，于是我尝试使用<code>View.setOnApplyWindowInsetsListener</code>，监听<code>WindowInsets</code>的变化发现，这个回调有可能会触发多次，在触发多次的情况下，前几次的值都为0，只有最后一次的值为真正的导航栏高度</p>
<p>于是我准备用<code>View.setOnApplyWindowInsetsListener</code>代替<code>View.addOnAttachStateChangeListener</code>，但毕竟一个是setListener，一个是addListener，setListener有可能会把之前设置好的Listener覆盖，或者被别的Listener覆盖掉，再考虑到之后会提到的底部<code>Dialog</code>沉浸式导航栏适配的问题，我折中了一下，决定只对<code>Activity</code>下的<code>rootView</code>设置回调</p>
<p>以下是完整代码</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">NavigationViewInfo</span></span>(</span><br><span class="line">    <span class="keyword">val</span> hostRef: WeakReference&lt;View&gt;,</span><br><span class="line">    <span class="keyword">val</span> viewRef: WeakReference&lt;View&gt;,</span><br><span class="line">    <span class="keyword">val</span> rawBottom: <span class="built_in">Int</span>,</span><br><span class="line">    <span class="keyword">val</span> onNavHeightChangeListener: (View, <span class="built_in">Int</span>, <span class="built_in">Int</span>) -&gt; <span class="built_in">Unit</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> navigationViewInfoList = mutableListOf&lt;NavigationViewInfo&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> onApplyWindowInsetsListener = View.OnApplyWindowInsetsListener &#123; v, insets -&gt;</span><br><span class="line">    <span class="keyword">val</span> windowInsetsCompat = WindowInsetsCompat.toWindowInsetsCompat(insets, v)</span><br><span class="line">    <span class="keyword">val</span> navHeight =</span><br><span class="line">        windowInsetsCompat.getInsets(WindowInsetsCompat.Type.navigationBars()).bottom</span><br><span class="line">    <span class="keyword">val</span> it = navigationViewInfoList.iterator()</span><br><span class="line">    <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">val</span> info = it.next()</span><br><span class="line">        <span class="keyword">val</span> host = info.hostRef.<span class="keyword">get</span>()</span><br><span class="line">        <span class="keyword">val</span> view = info.viewRef.<span class="keyword">get</span>()</span><br><span class="line">        <span class="keyword">if</span> (host == <span class="literal">null</span> || view == <span class="literal">null</span>) &#123;</span><br><span class="line">            it.remove()</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (host == v) &#123;</span><br><span class="line">            info.onNavHeightChangeListener(view, info.rawBottom, navHeight)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    insets</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> actionMarginNavigation: (View, <span class="built_in">Int</span>, <span class="built_in">Int</span>) -&gt; <span class="built_in">Unit</span> =</span><br><span class="line">    &#123; view, rawBottomMargin, navHeight -&gt;</span><br><span class="line">        (view.layoutParams <span class="keyword">as</span>? ViewGroup.MarginLayoutParams)?.let &#123;</span><br><span class="line">            it.bottomMargin = rawBottomMargin + navHeight</span><br><span class="line">            view.requestLayout()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> actionPaddingNavigation: (View, <span class="built_in">Int</span>, <span class="built_in">Int</span>) -&gt; <span class="built_in">Unit</span> =</span><br><span class="line">    &#123; view, rawBottomPadding, navHeight -&gt;</span><br><span class="line">        view.setPadding(</span><br><span class="line">            view.paddingLeft,</span><br><span class="line">            view.paddingTop,</span><br><span class="line">            view.paddingRight,</span><br><span class="line">            rawBottomPadding + navHeight</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">fixNavBarMargin</span><span class="params">(<span class="keyword">vararg</span> views: <span class="type">View</span>)</span></span> &#123;</span><br><span class="line">    views.forEach &#123;</span><br><span class="line">        fixSingleNavBarMargin(it)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">fixSingleNavBarMargin</span><span class="params">(view: <span class="type">View</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> lp = view.layoutParams <span class="keyword">as</span>? ViewGroup.MarginLayoutParams ?: <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">val</span> rawBottomMargin = lp.bottomMargin</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> viewForCalculate = getViewForCalculate(view)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (viewForCalculate.isAttachedToWindow) &#123;</span><br><span class="line">        <span class="keyword">val</span> realNavigationBarHeight = getRealNavigationBarHeight(viewForCalculate)</span><br><span class="line">        lp.bottomMargin = rawBottomMargin + realNavigationBarHeight</span><br><span class="line">        view.requestLayout()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//isAttachedToWindow方法并不能保证此时的WindowInsets是正确的，仍然需要添加监听</span></span><br><span class="line">    <span class="keyword">val</span> hostRef = WeakReference(viewForCalculate)</span><br><span class="line">    <span class="keyword">val</span> viewRef = WeakReference(view)</span><br><span class="line">    <span class="keyword">val</span> info = NavigationViewInfo(hostRef, viewRef, rawBottomMargin, actionMarginNavigation)</span><br><span class="line">    navigationViewInfoList.add(info)</span><br><span class="line">    viewForCalculate.setOnApplyWindowInsetsListener(onApplyWindowInsetsListener)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">paddingByNavBar</span><span class="params">(view: <span class="type">View</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> rawBottomPadding = view.paddingBottom</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> viewForCalculate = getViewForCalculate(view)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (viewForCalculate.isAttachedToWindow) &#123;</span><br><span class="line">        <span class="keyword">val</span> realNavigationBarHeight = getRealNavigationBarHeight(viewForCalculate)</span><br><span class="line">        view.setPadding(</span><br><span class="line">            view.paddingLeft,</span><br><span class="line">            view.paddingTop,</span><br><span class="line">            view.paddingRight,</span><br><span class="line">            rawBottomPadding + realNavigationBarHeight</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//isAttachedToWindow方法并不能保证此时的WindowInsets是正确的，仍然需要添加监听</span></span><br><span class="line">    <span class="keyword">val</span> hostRef = WeakReference(viewForCalculate)</span><br><span class="line">    <span class="keyword">val</span> viewRef = WeakReference(view)</span><br><span class="line">    <span class="keyword">val</span> info =</span><br><span class="line">        NavigationViewInfo(hostRef, viewRef, rawBottomPadding, actionPaddingNavigation)</span><br><span class="line">    navigationViewInfoList.add(info)</span><br><span class="line">    viewForCalculate.setOnApplyWindowInsetsListener(onApplyWindowInsetsListener)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Dialog下的View在低版本机型中获取到的WindowInsets值有误，</span></span><br><span class="line"><span class="comment">* 所以尝试去获得Activity的contentView，通过Activity的contentView获取WindowInsets</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@SuppressLint(<span class="meta-string">"ContextCast"</span>)</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getViewForCalculate</span><span class="params">(view: <span class="type">View</span>)</span></span>: View &#123;</span><br><span class="line">    <span class="keyword">return</span> (view.context <span class="keyword">as</span>? ContextWrapper)?.let &#123;</span><br><span class="line">        <span class="keyword">return</span><span class="symbol">@let</span> (it.baseContext <span class="keyword">as</span>? Activity)?.findViewById&lt;View&gt;(android.R.id.content)?.rootView</span><br><span class="line">    &#125; ?: view.rootView</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 仅当view attach window后生效</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getRealNavigationBarHeight</span><span class="params">(view: <span class="type">View</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> insets = ViewCompat.getRootWindowInsets(view)</span><br><span class="line">        ?.getInsets(WindowInsetsCompat.Type.navigationBars())</span><br><span class="line">    <span class="keyword">return</span> insets?.bottom ?: getNavigationBarHeight(view.context)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我简单解释一下这段代码：为所有需要沉浸的页面的根<code>View</code>设置同一个回调，并将待适配导航栏高度的<code>View</code>添加到列表中，当<code>WindowInsets</code>回调触发后，遍历这个列表，判断触发回调的<code>View</code>的<code>host</code>是否与待适配导航栏高度的<code>View</code>对应，对应的话则处理<code>View</code>适配导航栏高度</p>
<p>这里需要注意，<code>WindowInsets</code>的分发其实是在<code>dispatchAttachedToWindow</code>之后的，所以<code>isAttachedToWindow</code>方法并不能保证此时的<code>WindowInsets</code>是正确的，具体可以去看<code>ViewRootImpl</code>中的源码，关键方法：<code>dispatchApplyInsets</code>，这里判断<code>isAttachedToWindow</code>并设置高度是为了防止出现<code>View</code>已经完全布局完成，之后再也不会触发<code>OnApplyWindowInsets</code>的情况</p>
<p>这里我也测试了内存泄漏情况，确认无内存泄漏，大家可以放心食用</p>
<h1 id="底部Dialog适配沉浸式"><a href="#底部Dialog适配沉浸式" class="headerlink" title="底部Dialog适配沉浸式"></a>底部Dialog适配沉浸式</h1><p>底部<code>Dialog</code>适配沉浸式要比正常的<code>Activity</code>更麻烦一些，主要问题也是集中在沉浸式导航栏上</p>
<h2 id="获取导航栏高度-1"><a href="#获取导航栏高度-1" class="headerlink" title="获取导航栏高度"></a>获取导航栏高度</h2><p>仔细的小伙伴们可以已经注意到了我在沉浸式导航栏获取高度那里代码中的注释，<code>Dialog</code>下的<code>View</code>在低版本机型（经测试，<code>Android 9</code>一下就会有这个问题）中获取到的<code>WindowInsets</code>值有误，所以尝试去获得<code>Activity</code>的<code>contentView</code>，通过<code>Activity</code>的<code>contentView</code>获取<code>WindowInsets</code></p>
<h2 id="LayoutParams导致的异常"><a href="#LayoutParams导致的异常" class="headerlink" title="LayoutParams导致的异常"></a>LayoutParams导致的异常</h2><p>在某些系统上（比如MIUI），当我<code>window.setLayout(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT)</code>时，沉浸式会出现问题，状态栏会被蒙层盖住，<code>Dialog</code>底部的内容也会被一个莫名其妙的东西遮挡住</p>
<p>我的解决方案是，<code>window.setLayout(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT)</code>，然后布局最外层全部占满，内部留一个底部容器</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- dialog_pangu_bottom_wrapper --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">FrameLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">"@android:color/transparent"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/pangu_bottom_dialog_container"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">"bottom"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:clickable</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:focusable</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后在代码中重写<code>setContentView</code>方法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> canceledOnTouchOutside = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">setContentView</span><span class="params">(layoutResID: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    setContentView(</span><br><span class="line">        LayoutInflater.from(context).inflate(layoutResID, <span class="literal">null</span>, <span class="literal">false</span>)</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">setContentView</span><span class="params">(view: <span class="type">View</span>)</span></span> &#123;</span><br><span class="line">    setContentView(</span><br><span class="line">        view,</span><br><span class="line">        ViewGroup.LayoutParams(</span><br><span class="line">            ViewGroup.LayoutParams.MATCH_PARENT,</span><br><span class="line">            ViewGroup.LayoutParams.WRAP_CONTENT</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">setContentView</span><span class="params">(view: <span class="type">View</span>, params: <span class="type">ViewGroup</span>.<span class="type">LayoutParams</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> root =</span><br><span class="line">        LayoutInflater.from(context).inflate(R.layout.dialog_pangu_bottom_wrapper, <span class="literal">null</span>, <span class="literal">false</span>)</span><br><span class="line">    root.setOnClickListener &#123;</span><br><span class="line">        <span class="keyword">if</span> (canceledOnTouchOutside) &#123;</span><br><span class="line">            dismiss()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> container = root.findViewById&lt;ViewGroup&gt;(R.id.pangu_bottom_dialog_container)</span><br><span class="line">    container.addView(view, params)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">super</span>.setContentView(</span><br><span class="line">        root,</span><br><span class="line">        ViewGroup.LayoutParams(</span><br><span class="line">            ViewGroup.LayoutParams.MATCH_PARENT,</span><br><span class="line">            ViewGroup.LayoutParams.MATCH_PARENT</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">setCanceledOnTouchOutside</span><span class="params">(cancel: <span class="type">Boolean</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.setCanceledOnTouchOutside(cancel)</span><br><span class="line">    canceledOnTouchOutside = cancel</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样的话视觉效果就和普通的底部<code>Dialog</code>一样了，为了进一步减小底部<code>Dialog</code>显示隐藏动画之间的差异，我将动画插值器从<code>linear_interpolator</code>换成了<code>decelerate_interpolator</code>和<code>accelerate_interpolator</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- dialog_enter_from_bottom_to_top --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">translate</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:duration</span>=<span class="string">"300"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:fromYDelta</span>=<span class="string">"100%"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:interpolator</span>=<span class="string">"@android:anim/decelerate_interpolator"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:toYDelta</span>=<span class="string">"0"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- dialog_exit_from_top_to_bottom --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">translate</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:duration</span>=<span class="string">"300"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:fromYDelta</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:interpolator</span>=<span class="string">"@android:anim/accelerate_interpolator"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:toYDelta</span>=<span class="string">"100%"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a>尾声</h1><p>自此，目前沉浸式遇到的问题全部都解决了，如果以后发现了什么新的问题，我会在这篇文章中补充说明，如果还有什么不明白的地方可以评论，我考虑要不要拿几个具体的场景实战讲解，各位看官老爷麻烦点个赞收个藏不迷路😄</p>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/%E6%B2%89%E6%B5%B8%E5%BC%8F/">沉浸式</a><a class="post-meta__tags" href="/tags/%E7%8A%B6%E6%80%81%E6%A0%8F/">状态栏</a><a class="post-meta__tags" href="/tags/%E5%AF%BC%E8%88%AA%E6%A0%8F/">导航栏</a><a class="post-meta__tags" href="/tags/StatusBar/">StatusBar</a><a class="post-meta__tags" href="/tags/NavigationBar/">NavigationBar</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2023/02/06/android/aosp/WSL%E7%BC%96%E8%AF%91AOSP%E5%BF%85%E8%A6%81%E7%9A%84%E5%87%A0%E4%B8%AA%E5%89%8D%E7%BD%AE%E5%B7%A5%E4%BD%9C/"><i class="fa fa-chevron-left">  </i><span>WSL编译AOSP必要的几个前置工作</span></a></div><div class="next-post pull-right"><a href="/2022/12/19/android/aosp/Android%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%EF%BC%88%E4%B8%8B%EF%BC%89/"><span>Android源码分析 - Activity启动流程（下）</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(/images/background.jpeg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2023 By dreamgyf</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>