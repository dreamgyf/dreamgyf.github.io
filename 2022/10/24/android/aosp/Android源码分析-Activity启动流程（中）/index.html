<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Android源码分析 - Activity启动流程（中）"><meta name="keywords" content="Android源码,ActivityThread,ActivityManagerService"><meta name="author" content="dreamgyf"><meta name="copyright" content="dreamgyf"><title>Android源码分析 - Activity启动流程（中） | 始终都是梦</title><link rel="shortcut icon" href="/images/avatar.jpeg"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '4.2.1'
} </script><meta name="generator" content="Hexo 4.2.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#开篇"><span class="toc-number">1.</span> <span class="toc-text">开篇</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#启动App进程"><span class="toc-number">2.</span> <span class="toc-text">启动App进程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备ProcessRecord"><span class="toc-number">2.1.</span> <span class="toc-text">准备ProcessRecord</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#startProcess"><span class="toc-number">2.2.</span> <span class="toc-text">startProcess</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#向zygoto发送socket请求"><span class="toc-number">2.2.1.</span> <span class="toc-text">向zygoto发送socket请求</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#handleProcessStartedLocked"><span class="toc-number">2.3.</span> <span class="toc-text">handleProcessStartedLocked</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ActivityThread"><span class="toc-number">3.</span> <span class="toc-text">ActivityThread</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AMS-attachApplication"><span class="toc-number">4.</span> <span class="toc-text">AMS.attachApplication</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#获取ProcessRecord"><span class="toc-number">4.1.</span> <span class="toc-text">获取ProcessRecord</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#同步启动进程"><span class="toc-number">4.1.1.</span> <span class="toc-text">同步启动进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异步启动进程"><span class="toc-number">4.1.2.</span> <span class="toc-text">异步启动进程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ApplicationThread-bindApplication"><span class="toc-number">5.</span> <span class="toc-text">ApplicationThread.bindApplication</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#LoadedApk-makeApplication"><span class="toc-number">5.1.</span> <span class="toc-text">LoadedApk.makeApplication</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ContextImpl-createAppContext"><span class="toc-number">5.1.1.</span> <span class="toc-text">ContextImpl.createAppContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Instrumentation-newApplication"><span class="toc-number">5.1.2.</span> <span class="toc-text">Instrumentation.newApplication</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#结束"><span class="toc-number">6.</span> <span class="toc-text">结束</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/images/avatar.jpeg"></div><div class="author-info__name text-center">dreamgyf</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">41</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">44</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">29</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/images/background.jpeg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">始终都是梦</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">主页</a><a class="site-page" href="/archives">文章</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Android源码分析 - Activity启动流程（中）</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-10-24</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/">Android</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/ActivityThread/">ActivityThread</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/ActivityManagerService/">ActivityManagerService</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="开篇"><a href="#开篇" class="headerlink" title="开篇"></a>开篇</h1><p><strong>本篇以android-11.0.0_r25作为基础解析</strong></p>
<p>上一篇文章 <a href="https://juejin.cn/post/7130182223231188999" target="_blank" rel="noopener">Android源码分析 - Activity启动流程（上）</a> 中，我们分析了<code>Activity</code>启动流程中的一小部分，基本上可以算是<code>Activity</code>启动的前置准备工作，这篇文章我们将会分析App进程启动的主要流程</p>
<h1 id="启动App进程"><a href="#启动App进程" class="headerlink" title="启动App进程"></a>启动App进程</h1><h2 id="准备ProcessRecord"><a href="#准备ProcessRecord" class="headerlink" title="准备ProcessRecord"></a>准备ProcessRecord</h2><p>上篇文章中我们说过了，如果App尚未启动，则会调用<code>ATMS</code>的<code>startProcessAsync</code>方法去启动App进程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startProcessAsync</span><span class="params">(ActivityRecord activity, <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">boolean</span> isTop,</span></span></span><br><span class="line"><span class="function"><span class="params">        String hostingType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Post message to start process to avoid possible deadlock of calling into AMS with the</span></span><br><span class="line">        <span class="comment">// ATMS lock held.</span></span><br><span class="line">        <span class="keyword">final</span> Message m = PooledLambda.obtainMessage(ActivityManagerInternal::startProcess,</span><br><span class="line">                mAmInternal, activity.processName, activity.info.applicationInfo, knownToBeDead,</span><br><span class="line">                isTop, hostingType, activity.intent.getComponent());</span><br><span class="line">        mH.sendMessage(m);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法实际上是通过<code>Hander</code>调用了<code>ActivityManagerInternal (AMS.LocalService)</code>的<code>startProcess</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startProcess</span><span class="params">(String processName, ApplicationInfo info, <span class="keyword">boolean</span> knownToBeDead,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isTop, String hostingType, ComponentName hostingName)</span> </span>&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">synchronized</span> (ActivityManagerService.<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// If the process is known as top app, set a hint so when the process is</span></span><br><span class="line">        <span class="comment">// started, the top priority can be applied immediately to avoid cpu being</span></span><br><span class="line">        <span class="comment">// preempted by other processes before attaching the process of top app.</span></span><br><span class="line">        startProcessLocked(processName, info, knownToBeDead, <span class="number">0</span> <span class="comment">/* intentFlags */</span>,</span><br><span class="line">                <span class="keyword">new</span> HostingRecord(hostingType, hostingName, isTop),</span><br><span class="line">                ZYGOTE_POLICY_FLAG_LATENCY_SENSITIVE, <span class="keyword">false</span> <span class="comment">/* allowWhileBooting */</span>,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/* isolated */</span>, <span class="keyword">true</span> <span class="comment">/* keepIfLarge */</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里将进程启动的一些信息封装到了<code>HostingRecord</code>类中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(String processName,</span></span></span><br><span class="line"><span class="function"><span class="params">    ApplicationInfo info, <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">int</span> intentFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">    HostingRecord hostingRecord, <span class="keyword">int</span> zygotePolicyFlags, <span class="keyword">boolean</span> allowWhileBooting,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> isolated, <span class="keyword">boolean</span> keepIfLarge)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> mProcessList.startProcessLocked(processName, info, knownToBeDead, intentFlags,</span><br><span class="line">        hostingRecord, zygotePolicyFlags, allowWhileBooting, isolated, <span class="number">0</span> <span class="comment">/* isolatedUid */</span>,</span><br><span class="line">        keepIfLarge, <span class="keyword">null</span> <span class="comment">/* ABI override */</span>, <span class="keyword">null</span> <span class="comment">/* entryPoint */</span>,</span><br><span class="line">        <span class="keyword">null</span> <span class="comment">/* entryPointArgs */</span>, <span class="keyword">null</span> <span class="comment">/* crashHandler */</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AMS</code>将启动进程的任务转交给了<code>ProcessList</code>，这个类的职责是管理进程，包括管理进程优先级(Adj)、进程OOM等</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(String processName, ApplicationInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">int</span> intentFlags, HostingRecord hostingRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> zygotePolicyFlags, <span class="keyword">boolean</span> allowWhileBooting, <span class="keyword">boolean</span> isolated, <span class="keyword">int</span> isolatedUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> keepIfLarge, String abiOverride, String entryPoint, String[] entryPointArgs,</span></span></span><br><span class="line"><span class="function"><span class="params">        Runnable crashHandler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line">    ProcessRecord app;</span><br><span class="line">    <span class="keyword">if</span> (!isolated) &#123;</span><br><span class="line">        <span class="comment">//先通过进程名和uid查找相应App的ProcessRecord</span></span><br><span class="line">        app = getProcessRecordLocked(processName, info.uid, keepIfLarge);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果是由后台进程发起的 startProcess</span></span><br><span class="line">        <span class="comment">//判断启动进程是否为 bad process，如果是，直接启动失败返回</span></span><br><span class="line">        <span class="comment">//这里 bad process 的定义为：短时间内连续崩溃两次以上的进程</span></span><br><span class="line">        <span class="keyword">if</span> ((intentFlags &amp; Intent.FLAG_FROM_BACKGROUND) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// If we are in the background, then check to see if this process</span></span><br><span class="line">            <span class="comment">// is bad.  If so, we will just silently fail.</span></span><br><span class="line">            <span class="keyword">if</span> (mService.mAppErrors.isBadProcessLocked(info)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// When the user is explicitly starting a process, then clear its</span></span><br><span class="line">            <span class="comment">// crash count so that we won't make it bad until they see at</span></span><br><span class="line">            <span class="comment">// least one crash dialog again, and make the process good again</span></span><br><span class="line">            <span class="comment">// if it had been bad.</span></span><br><span class="line">            <span class="comment">//如果是用户显式的要求启动进程，则会清空启动进程的崩溃次数，将启动进程从 bad process 列表中移除</span></span><br><span class="line">            mService.mAppErrors.resetProcessCrashTimeLocked(info);</span><br><span class="line">            <span class="keyword">if</span> (mService.mAppErrors.isBadProcessLocked(info)) &#123;</span><br><span class="line">                EventLog.writeEvent(EventLogTags.AM_PROC_GOOD,</span><br><span class="line">                        UserHandle.getUserId(info.uid), info.uid,</span><br><span class="line">                        info.processName);</span><br><span class="line">                mService.mAppErrors.clearBadProcessLocked(info);</span><br><span class="line">                <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    app.bad = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If this is an isolated process, it can't re-use an existing process.</span></span><br><span class="line">        app = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We don't have to do anything more if:</span></span><br><span class="line">    <span class="comment">// (1) There is an existing application record; and</span></span><br><span class="line">    <span class="comment">// (2) The caller doesn't think it is dead, OR there is no thread</span></span><br><span class="line">    <span class="comment">//     object attached to it so we know it couldn't have crashed; and</span></span><br><span class="line">    <span class="comment">// (3) There is a pid assigned to it, so it is either starting or</span></span><br><span class="line">    <span class="comment">//     already running.</span></span><br><span class="line">    ProcessRecord precedence = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//如果已经存在了对应App的ProcessRecord，并且分配了pid</span></span><br><span class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//如果进程没有死亡或者进程还未绑定binder线程，说明进程是正常运行状态或正在启动中</span></span><br><span class="line">        <span class="keyword">if</span> ((!knownToBeDead &amp;&amp; !app.killed) || app.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// We already have the app running, or are waiting for it to</span></span><br><span class="line">            <span class="comment">// come up (we have a pid but not yet its thread), so keep it.</span></span><br><span class="line">            <span class="comment">// If this is a new package in the process, add the package to the list</span></span><br><span class="line">            <span class="comment">//将要启动的包信息记录在ProcessRecord中（Android多个App可以运行在同一个进程中）</span></span><br><span class="line">            app.addPackage(info.packageName, info.longVersionCode, mService.mProcessStats);</span><br><span class="line">            <span class="keyword">return</span> app;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// An application record is attached to a previous process,</span></span><br><span class="line">        <span class="comment">// clean it up now.</span></span><br><span class="line">        <span class="comment">//App绑定在之前的一个进程上了，杀死并清理这个进程</span></span><br><span class="line">        ProcessList.killProcessGroup(app.uid, app.pid);</span><br><span class="line"></span><br><span class="line">        Slog.wtf(TAG_PROCESSES, app.toString() + <span class="string">" is attached to a previous process"</span>);</span><br><span class="line">        <span class="comment">// We are not going to re-use the ProcessRecord, as we haven't dealt with the cleanup</span></span><br><span class="line">        <span class="comment">// routine of it yet, but we'd set it as the precedence of the new process.</span></span><br><span class="line">        precedence = app;</span><br><span class="line">        app = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//没有找到对应的ProcessRecord</span></span><br><span class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//新创建一个ProcessRecord对象</span></span><br><span class="line">        app = newProcessRecordLocked(info, processName, isolated, isolatedUid, hostingRecord);</span><br><span class="line">        <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Failed making new process record for "</span></span><br><span class="line">                    + processName + <span class="string">"/"</span> + info.uid + <span class="string">" isolated="</span> + isolated);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        app.crashHandler = crashHandler;</span><br><span class="line">        app.isolatedEntryPoint = entryPoint;</span><br><span class="line">        app.isolatedEntryPointArgs = entryPointArgs;</span><br><span class="line">        <span class="keyword">if</span> (precedence != <span class="keyword">null</span>) &#123;</span><br><span class="line">            app.mPrecedence = precedence;</span><br><span class="line">            precedence.mSuccessor = app;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;    <span class="comment">//存在对应的ProcessRecord，但进程尚未启动或已被清理</span></span><br><span class="line">        <span class="comment">// If this is a new package in the process, add the package to the list</span></span><br><span class="line">        <span class="comment">//将要启动的包信息记录在ProcessRecord中</span></span><br><span class="line">        app.addPackage(info.packageName, info.longVersionCode, mService.mProcessStats);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the system is not ready yet, then hold off on starting this</span></span><br><span class="line">    <span class="comment">// process until it is.</span></span><br><span class="line">    <span class="comment">//如果系统尚未准备好（开机中或system_server进程崩溃重启中），将其先添加到等待队列中</span></span><br><span class="line">    <span class="keyword">if</span> (!mService.mProcessesReady</span><br><span class="line">            &amp;&amp; !mService.isAllowedWhileBooting(info)</span><br><span class="line">            &amp;&amp; !allowWhileBooting) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mService.mProcessesOnHold.contains(app)) &#123;</span><br><span class="line">            mService.mProcessesOnHold.add(app);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> app;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> success =</span><br><span class="line">            startProcessLocked(app, hostingRecord, zygotePolicyFlags, abiOverride);</span><br><span class="line">    <span class="keyword">return</span> success ? app : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法主要是处理<code>ProcessRecord</code>对象，如果找不到对应的<code>ProcessRecord</code>或对应的<code>ProcessRecord</code>里的信息表明App进程尚未启动，则会调用另一个<code>startProcessLocked</code>重载方法启动进程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app, HostingRecord hostingRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> zygotePolicyFlags, String abiOverride)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> startProcessLocked(app, hostingRecord, zygotePolicyFlags,</span><br><span class="line">            <span class="keyword">false</span> <span class="comment">/* disableHiddenApiChecks */</span>, <span class="keyword">false</span> <span class="comment">/* disableTestApiChecks */</span>,</span><br><span class="line">            <span class="keyword">false</span> <span class="comment">/* mountExtStorageFull */</span>, abiOverride);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app, HostingRecord hostingRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> zygotePolicyFlags, <span class="keyword">boolean</span> disableHiddenApiChecks, <span class="keyword">boolean</span> disableTestApiChecks,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> mountExtStorageFull, String abiOverride)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//进程正在启动中</span></span><br><span class="line">    <span class="keyword">if</span> (app.pendingStart) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//从刚才方法中的判断来看，应该不会进入这个case</span></span><br><span class="line">    <span class="keyword">if</span> (app.pid &gt; <span class="number">0</span> &amp;&amp; app.pid != ActivityManagerService.MY_PID) &#123;</span><br><span class="line">        <span class="comment">//将ProcessRecord的pid从PidMap中移除</span></span><br><span class="line">        mService.removePidLocked(app);</span><br><span class="line">        app.bindMountPending = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//将ProcessRecord的pid重置为0</span></span><br><span class="line">        app.setPid(<span class="number">0</span>);</span><br><span class="line">        app.startSeq = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将ProcessRecord从启动等待队列中移除</span></span><br><span class="line">    mService.mProcessesOnHold.remove(app);</span><br><span class="line"></span><br><span class="line">    mService.updateCpuStats();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//检测当前用户是否可以启动这个App</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> userId = UserHandle.getUserId(app.uid);</span><br><span class="line">            AppGlobals.getPackageManager().checkPackageStartable(app.info.packageName, userId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e.rethrowAsRuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> uid = app.uid;</span><br><span class="line">        <span class="keyword">int</span>[] gids = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//默认不挂载外置存储</span></span><br><span class="line">        <span class="keyword">int</span> mountExternal = Zygote.MOUNT_EXTERNAL_NONE;</span><br><span class="line">        <span class="keyword">if</span> (!app.isolated) &#123;</span><br><span class="line">            <span class="keyword">int</span>[] permGids = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> IPackageManager pm = AppGlobals.getPackageManager();</span><br><span class="line">                <span class="comment">//获取GIDS（App申请的权限）</span></span><br><span class="line">                permGids = pm.getPackageGids(app.info.packageName,</span><br><span class="line">                        MATCH_DIRECT_BOOT_AUTO, app.userId);</span><br><span class="line">                <span class="keyword">if</span> (StorageManager.hasIsolatedStorage() &amp;&amp; mountExtStorageFull) &#123;</span><br><span class="line">                    <span class="comment">//挂载外置存储，允许读写</span></span><br><span class="line">                    mountExternal = Zygote.MOUNT_EXTERNAL_FULL;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    StorageManagerInternal storageManagerInternal = LocalServices.getService(</span><br><span class="line">                            StorageManagerInternal<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                    <span class="comment">//获取App对外置存储的读写权限</span></span><br><span class="line">                    mountExternal = storageManagerInternal.getExternalStorageMountMode(uid,</span><br><span class="line">                            app.info.packageName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e.rethrowAsRuntimeException();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Remove any gids needed if the process has been denied permissions.</span></span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> eventually we should probably have the package manager pre-compute</span></span><br><span class="line">            <span class="comment">// this for us?</span></span><br><span class="line">            <span class="comment">//从刚刚过去的App申请权限中剔除进程所被拒绝的权限</span></span><br><span class="line">            <span class="keyword">if</span> (app.processInfo != <span class="keyword">null</span> &amp;&amp; app.processInfo.deniedPermissions != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = app.processInfo.deniedPermissions.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                    <span class="keyword">int</span>[] denyGids = mService.mPackageManagerInt.getPermissionGids(</span><br><span class="line">                            app.processInfo.deniedPermissions.valueAt(i), app.userId);</span><br><span class="line">                    <span class="keyword">if</span> (denyGids != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> gid : denyGids) &#123;</span><br><span class="line">                            permGids = ArrayUtils.removeInt(permGids, gid);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//计算得出进程所应拥有的所有权限</span></span><br><span class="line">            gids = computeGidsForProcess(mountExternal, uid, permGids);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//设置挂载模式</span></span><br><span class="line">        app.mountMode = mountExternal;</span><br><span class="line">        <span class="comment">//工厂测试进程</span></span><br><span class="line">        <span class="keyword">if</span> (mService.mAtmInternal.isFactoryTestProcess(app.getWindowProcessController())) &#123;</span><br><span class="line">            uid = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//进程启动参数（传递到Zygoto）</span></span><br><span class="line">        <span class="keyword">int</span> runtimeFlags = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//如果manifest中设置了android:debuggable</span></span><br><span class="line">        <span class="keyword">if</span> ((app.info.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>) &#123;</span><br><span class="line">            runtimeFlags |= Zygote.DEBUG_ENABLE_JDWP;</span><br><span class="line">            runtimeFlags |= Zygote.DEBUG_JAVA_DEBUGGABLE;</span><br><span class="line">            <span class="comment">// Also turn on CheckJNI for debuggable apps. It's quite</span></span><br><span class="line">            <span class="comment">// awkward to turn on otherwise.</span></span><br><span class="line">            runtimeFlags |= Zygote.DEBUG_ENABLE_CHECKJNI;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check if the developer does not want ART verification</span></span><br><span class="line">            <span class="keyword">if</span> (android.provider.Settings.Global.getInt(mService.mContext.getContentResolver(),</span><br><span class="line">                    android.provider.Settings.Global.ART_VERIFIER_VERIFY_DEBUGGABLE, <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                runtimeFlags |= Zygote.DISABLE_VERIFIER;</span><br><span class="line">                Slog.w(TAG_PROCESSES, app + <span class="string">": ART verification disabled"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ... <span class="comment">//设置各种高进程启动参数</span></span><br><span class="line"></span><br><span class="line">        String invokeWith = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//如果manifest中设置了android:debuggable</span></span><br><span class="line">        <span class="comment">//使用logwrapper工具捕获stdout信息</span></span><br><span class="line">        <span class="keyword">if</span> ((app.info.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Debuggable apps may include a wrapper script with their library directory.</span></span><br><span class="line">            String wrapperFileName = app.info.nativeLibraryDir + <span class="string">"/wrap.sh"</span>;</span><br><span class="line">            StrictMode.ThreadPolicy oldPolicy = StrictMode.allowThreadDiskReads();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">new</span> File(wrapperFileName).exists()) &#123;</span><br><span class="line">                    invokeWith = <span class="string">"/system/bin/logwrapper "</span> + wrapperFileName;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                StrictMode.setThreadPolicy(oldPolicy);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//确定App进程使用的abi（有so库的App会通过so库的架构决定，没有so库的使用系统最优先支持的abi）</span></span><br><span class="line">        String requiredAbi = (abiOverride != <span class="keyword">null</span>) ? abiOverride : app.info.primaryCpuAbi;</span><br><span class="line">        <span class="keyword">if</span> (requiredAbi == <span class="keyword">null</span>) &#123;</span><br><span class="line">            requiredAbi = Build.SUPPORTED_ABIS[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将abi转成InstructionSet</span></span><br><span class="line">        String instructionSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (app.info.primaryCpuAbi != <span class="keyword">null</span>) &#123;</span><br><span class="line">            instructionSet = VMRuntime.getInstructionSet(app.info.primaryCpuAbi);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        app.gids = gids;</span><br><span class="line">        app.setRequiredAbi(requiredAbi);</span><br><span class="line">        app.instructionSet = instructionSet;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String seInfo = app.info.seInfo</span><br><span class="line">                + (TextUtils.isEmpty(app.info.seInfoUser) ? <span class="string">""</span> : app.info.seInfoUser);</span><br><span class="line">        <span class="comment">// Start the process.  It will either succeed and return a result containing</span></span><br><span class="line">        <span class="comment">// the PID of the new process, or else throw a RuntimeException.</span></span><br><span class="line">        <span class="comment">//重要：设置进程启动入口</span></span><br><span class="line">        <span class="keyword">final</span> String entryPoint = <span class="string">"android.app.ActivityThread"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//启动进程</span></span><br><span class="line">        <span class="keyword">return</span> startProcessLocked(hostingRecord, entryPoint, app, uid, gids,</span><br><span class="line">                runtimeFlags, zygotePolicyFlags, mountExternal, seInfo, requiredAbi,</span><br><span class="line">                instructionSet, invokeWith, startTime);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">        mService.forceStopPackageLocked(app.info.packageName, UserHandle.getAppId(app.uid),</span><br><span class="line">                <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, app.userId, <span class="string">"start failure"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这一步位置仍然是在进行准备工作，主要做了以下几件事：</p>
<ol>
<li>权限处理：App安装时会检测<code>manifest</code>里申请的权限，并由此生成出一个<code>GIDS</code>数组</li>
<li>设置挂载模式</li>
<li>设置进程的各种启动参数</li>
<li>设置App进程使用的<code>abi</code></li>
<li>设置进程启动入口</li>
<li>继续调用重载方法启动进程</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startProcessLocked</span><span class="params">(HostingRecord hostingRecord, String entryPoint, ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> uid, <span class="keyword">int</span>[] gids, <span class="keyword">int</span> runtimeFlags, <span class="keyword">int</span> zygotePolicyFlags, <span class="keyword">int</span> mountExternal,</span></span></span><br><span class="line"><span class="function"><span class="params">        String seInfo, String requiredAbi, String instructionSet, String invokeWith,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> startTime)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//初始化一些参数</span></span><br><span class="line">    <span class="comment">//标识App进程正在启动</span></span><br><span class="line">    app.pendingStart = <span class="keyword">true</span>;</span><br><span class="line">    app.killedByAm = <span class="keyword">false</span>;</span><br><span class="line">    app.removed = <span class="keyword">false</span>;</span><br><span class="line">    app.killed = <span class="keyword">false</span>;</span><br><span class="line">    app.mDisabledCompatChanges = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (mPlatformCompat != <span class="keyword">null</span>) &#123;</span><br><span class="line">        app.mDisabledCompatChanges = mPlatformCompat.getDisabledChanges(app.info);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> startSeq = app.startSeq = ++mProcStartSeqCounter;</span><br><span class="line">    app.setStartParams(uid, hostingRecord, seInfo, startTime);</span><br><span class="line">    app.setUsingWrapper(invokeWith != <span class="keyword">null</span></span><br><span class="line">            || Zygote.getWrapProperty(app.processName) != <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">//将ProcessRecord添加到待启动列表中</span></span><br><span class="line">    mPendingStarts.put(startSeq, app);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mService.mConstants.FLAG_PROCESS_START_ASYNC) &#123;    <span class="comment">//异步启动进程</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.i(TAG_PROCESSES,</span><br><span class="line">                <span class="string">"Posting procStart msg for "</span> + app.toShortString());</span><br><span class="line">        mService.mProcStartHandler.post(() -&gt; handleProcessStart(</span><br><span class="line">                app, entryPoint, gids, runtimeFlags, zygotePolicyFlags, mountExternal,</span><br><span class="line">                requiredAbi, instructionSet, invokeWith, startSeq));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;    <span class="comment">//同步启动进程</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> Process.ProcessStartResult startResult = startProcess(hostingRecord,</span><br><span class="line">                    entryPoint, app,</span><br><span class="line">                    uid, gids, runtimeFlags, zygotePolicyFlags, mountExternal, seInfo,</span><br><span class="line">                    requiredAbi, instructionSet, invokeWith, startTime);</span><br><span class="line">            handleProcessStartedLocked(app, startResult.pid, startResult.usingWrapper,</span><br><span class="line">                    startSeq, <span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            <span class="comment">//出错，将pendingStart标志复位并强行停止进程</span></span><br><span class="line">            app.pendingStart = <span class="keyword">false</span>;</span><br><span class="line">            mService.forceStopPackageLocked(app.info.packageName, UserHandle.getAppId(app.uid),</span><br><span class="line">                    <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, app.userId, <span class="string">"start failure"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> app.pid &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在异步模式下，程序会等待<code>ProcessRecord.mPrecedence</code>进程结束才会启动进程（这里对应着最开始的<code>startProcessLocked</code>方法中，已经存在了对应App的<code>ProcessRecord</code>，并且分配了<code>pid</code>，但是进程被标记为死亡这种情况）</p>
<p>最终都会进入到<code>startProcess</code>和<code>handleProcessStartedLocked</code>方法中来</p>
<h2 id="startProcess"><a href="#startProcess" class="headerlink" title="startProcess"></a>startProcess</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Process.<span class="function">ProcessStartResult <span class="title">startProcess</span><span class="params">(HostingRecord hostingRecord, String entryPoint,</span></span></span><br><span class="line"><span class="function"><span class="params">        ProcessRecord app, <span class="keyword">int</span> uid, <span class="keyword">int</span>[] gids, <span class="keyword">int</span> runtimeFlags, <span class="keyword">int</span> zygotePolicyFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> mountExternal, String seInfo, String requiredAbi, String instructionSet,</span></span></span><br><span class="line"><span class="function"><span class="params">        String invokeWith, <span class="keyword">long</span> startTime)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isTopApp = hostingRecord.isTopApp();</span><br><span class="line">        <span class="keyword">if</span> (isTopApp) &#123;</span><br><span class="line">            <span class="comment">// Use has-foreground-activities as a temporary hint so the current scheduling</span></span><br><span class="line">            <span class="comment">// group won't be lost when the process is attaching. The actual state will be</span></span><br><span class="line">            <span class="comment">// refreshed when computing oom-adj.</span></span><br><span class="line">            app.setHasForegroundActivities(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//处理应用目录隔离机制</span></span><br><span class="line">        Map&lt;String, Pair&lt;String, Long&gt;&gt; pkgDataInfoMap;</span><br><span class="line">        Map&lt;String, Pair&lt;String, Long&gt;&gt; whitelistedAppDataInfoMap;</span><br><span class="line">        <span class="keyword">boolean</span> bindMountAppStorageDirs = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">boolean</span> bindMountAppsData = mAppDataIsolationEnabled</span><br><span class="line">                &amp;&amp; (UserHandle.isApp(app.uid) || UserHandle.isIsolated(app.uid))</span><br><span class="line">                &amp;&amp; mPlatformCompat.isChangeEnabled(APP_DATA_DIRECTORY_ISOLATION, app.info);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get all packages belongs to the same shared uid. sharedPackages is empty array</span></span><br><span class="line">        <span class="comment">// if it doesn't have shared uid.</span></span><br><span class="line">        <span class="keyword">final</span> PackageManagerInternal pmInt = mService.getPackageManagerInternalLocked();</span><br><span class="line">        <span class="keyword">final</span> String[] sharedPackages = pmInt.getSharedUserPackagesForPackage(</span><br><span class="line">                app.info.packageName, app.userId);</span><br><span class="line">        <span class="keyword">final</span> String[] targetPackagesList = sharedPackages.length == <span class="number">0</span></span><br><span class="line">                ? <span class="keyword">new</span> String[]&#123;app.info.packageName&#125; : sharedPackages;</span><br><span class="line"></span><br><span class="line">        pkgDataInfoMap = getPackageAppDataInfoMap(pmInt, targetPackagesList, uid);</span><br><span class="line">        <span class="keyword">if</span> (pkgDataInfoMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// TODO(b/152760674): Handle inode == 0 case properly, now we just give it a</span></span><br><span class="line">            <span class="comment">// tmp free pass.</span></span><br><span class="line">            bindMountAppsData = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Remove all packages in pkgDataInfoMap from mAppDataIsolationWhitelistedApps, so</span></span><br><span class="line">        <span class="comment">// it won't be mounted twice.</span></span><br><span class="line">        <span class="keyword">final</span> Set&lt;String&gt; whitelistedApps = <span class="keyword">new</span> ArraySet&lt;&gt;(mAppDataIsolationWhitelistedApps);</span><br><span class="line">        <span class="keyword">for</span> (String pkg : targetPackagesList) &#123;</span><br><span class="line">            whitelistedApps.remove(pkg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        whitelistedAppDataInfoMap = getPackageAppDataInfoMap(pmInt,</span><br><span class="line">                whitelistedApps.toArray(<span class="keyword">new</span> String[<span class="number">0</span>]), uid);</span><br><span class="line">        <span class="keyword">if</span> (whitelistedAppDataInfoMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// TODO(b/152760674): Handle inode == 0 case properly, now we just give it a</span></span><br><span class="line">            <span class="comment">// tmp free pass.</span></span><br><span class="line">            bindMountAppsData = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> userId = UserHandle.getUserId(uid);</span><br><span class="line">        StorageManagerInternal storageManagerInternal = LocalServices.getService(</span><br><span class="line">                StorageManagerInternal<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (needsStorageDataIsolation(storageManagerInternal, app)) &#123;</span><br><span class="line">            bindMountAppStorageDirs = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (pkgDataInfoMap == <span class="keyword">null</span> ||</span><br><span class="line">                    !storageManagerInternal.prepareStorageDirs(userId, pkgDataInfoMap.keySet(),</span><br><span class="line">                    app.processName)) &#123;</span><br><span class="line">                <span class="comment">// Cannot prepare Android/app and Android/obb directory or inode == 0,</span></span><br><span class="line">                <span class="comment">// so we won't mount it in zygote, but resume the mount after unlocking device.</span></span><br><span class="line">                app.bindMountPending = <span class="keyword">true</span>;</span><br><span class="line">                bindMountAppStorageDirs = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If it's an isolated process, it should not even mount its own app data directories,</span></span><br><span class="line">        <span class="comment">// since it has no access to them anyway.</span></span><br><span class="line">        <span class="keyword">if</span> (app.isolated) &#123;</span><br><span class="line">            pkgDataInfoMap = <span class="keyword">null</span>;</span><br><span class="line">            whitelistedAppDataInfoMap = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Process.ProcessStartResult startResult;</span><br><span class="line">        <span class="keyword">if</span> (hostingRecord.usesWebviewZygote()) &#123;</span><br><span class="line">            startResult = startWebView(entryPoint,</span><br><span class="line">                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class="line">                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                    app.info.dataDir, <span class="keyword">null</span>, app.info.packageName, app.mDisabledCompatChanges,</span><br><span class="line">                    <span class="keyword">new</span> String[]&#123;PROC_START_SEQ_IDENT + app.startSeq&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hostingRecord.usesAppZygote()) &#123;</span><br><span class="line">            <span class="keyword">final</span> AppZygote appZygote = createAppZygoteForProcessIfNeeded(app);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We can't isolate app data and storage data as parent zygote already did that.</span></span><br><span class="line">            startResult = appZygote.getProcess().start(entryPoint,</span><br><span class="line">                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class="line">                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                    app.info.dataDir, <span class="keyword">null</span>, app.info.packageName,</span><br><span class="line">                    <span class="comment">/*zygotePolicyFlags=*/</span> ZYGOTE_POLICY_FLAG_EMPTY, isTopApp,</span><br><span class="line">                    app.mDisabledCompatChanges, pkgDataInfoMap, whitelistedAppDataInfoMap,</span><br><span class="line">                    <span class="keyword">false</span>, <span class="keyword">false</span>,</span><br><span class="line">                    <span class="keyword">new</span> String[]&#123;PROC_START_SEQ_IDENT + app.startSeq&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;    <span class="comment">//没有特别指定hostingZygote时，进入此case</span></span><br><span class="line">            startResult = Process.start(entryPoint,</span><br><span class="line">                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class="line">                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                    app.info.dataDir, invokeWith, app.info.packageName, zygotePolicyFlags,</span><br><span class="line">                    isTopApp, app.mDisabledCompatChanges, pkgDataInfoMap,</span><br><span class="line">                    whitelistedAppDataInfoMap, bindMountAppsData, bindMountAppStorageDirs,</span><br><span class="line">                    <span class="keyword">new</span> String[]&#123;PROC_START_SEQ_IDENT + app.startSeq&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> startResult;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从<code>Android 11</code>开始引入了应用目录隔离机制，使得应用仅可以发现和访问自己的储存目录，不可以访问其他应用的储存目录</p>
<p>这里处理完应用目录隔离机制后，调用了<code>Process.start</code>方法启动进程，最终走到<code>ZygoteProcess.startViaZygote</code>方法</p>
<h3 id="向zygoto发送socket请求"><a href="#向zygoto发送socket请求" class="headerlink" title="向zygoto发送socket请求"></a>向zygoto发送socket请求</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Process.<span class="function">ProcessStartResult <span class="title">startViaZygote</span><span class="params">(@NonNull <span class="keyword">final</span> String processClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    @Nullable <span class="keyword">final</span> String niceName,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">final</span> <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> gid,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    @Nullable <span class="keyword">final</span> <span class="keyword">int</span>[] gids,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">int</span> runtimeFlags, <span class="keyword">int</span> mountExternal,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">int</span> targetSdkVersion,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    @Nullable String seInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    @NonNull String abi,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    @Nullable String instructionSet,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    @Nullable String appDataDir,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    @Nullable String invokeWith,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">boolean</span> startChildZygote,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    @Nullable String packageName,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">int</span> zygotePolicyFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">boolean</span> isTopApp,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    @Nullable <span class="keyword">long</span>[] disabledCompatChanges,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    @Nullable Map&lt;String, Pair&lt;String, Long&gt;&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">                                                            pkgDataInfoMap,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    @Nullable Map&lt;String, Pair&lt;String, Long&gt;&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">                                                            allowlistedDataInfoList,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">boolean</span> bindMountAppsData,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">boolean</span> bindMountAppStorageDirs,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    @Nullable String[] extraArgs)</span></span></span><br><span class="line"><span class="function">                                                    <span class="keyword">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class="line">    ArrayList&lt;String&gt; argsForZygote = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --runtime-args, --setuid=, --setgid=,</span></span><br><span class="line">    <span class="comment">// and --setgroups= must go first</span></span><br><span class="line">    argsForZygote.add(<span class="string">"--runtime-args"</span>);</span><br><span class="line">    argsForZygote.add(<span class="string">"--setuid="</span> + uid);</span><br><span class="line">    argsForZygote.add(<span class="string">"--setgid="</span> + gid);</span><br><span class="line">    argsForZygote.add(<span class="string">"--runtime-flags="</span> + runtimeFlags);</span><br><span class="line">    <span class="keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_DEFAULT) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">"--mount-external-default"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_INSTALLER) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">"--mount-external-installer"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_PASS_THROUGH) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">"--mount-external-pass-through"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_ANDROID_WRITABLE) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">"--mount-external-android-writable"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    argsForZygote.add(<span class="string">"--target-sdk-version="</span> + targetSdkVersion);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --setgroups is a comma-separated list</span></span><br><span class="line">    <span class="keyword">if</span> (gids != <span class="keyword">null</span> &amp;&amp; gids.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        sb.append(<span class="string">"--setgroups="</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> sz = gids.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">                sb.append(<span class="string">','</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sb.append(gids[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        argsForZygote.add(sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (niceName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">"--nice-name="</span> + niceName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (seInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">"--seinfo="</span> + seInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (instructionSet != <span class="keyword">null</span>) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">"--instruction-set="</span> + instructionSet);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (appDataDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">"--app-data-dir="</span> + appDataDir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (invokeWith != <span class="keyword">null</span>) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">"--invoke-with"</span>);</span><br><span class="line">        argsForZygote.add(invokeWith);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (startChildZygote) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">"--start-child-zygote"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        argsForZygote.add(<span class="string">"--package-name="</span> + packageName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isTopApp) &#123;</span><br><span class="line">        argsForZygote.add(Zygote.START_AS_TOP_APP_ARG);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pkgDataInfoMap != <span class="keyword">null</span> &amp;&amp; pkgDataInfoMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        sb.append(Zygote.PKG_DATA_INFO_MAP);</span><br><span class="line">        sb.append(<span class="string">"="</span>);</span><br><span class="line">        <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Pair&lt;String, Long&gt;&gt; entry : pkgDataInfoMap.entrySet()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (started) &#123;</span><br><span class="line">                sb.append(<span class="string">','</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            started = <span class="keyword">true</span>;</span><br><span class="line">            sb.append(entry.getKey());</span><br><span class="line">            sb.append(<span class="string">','</span>);</span><br><span class="line">            sb.append(entry.getValue().first);</span><br><span class="line">            sb.append(<span class="string">','</span>);</span><br><span class="line">            sb.append(entry.getValue().second);</span><br><span class="line">        &#125;</span><br><span class="line">        argsForZygote.add(sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (allowlistedDataInfoList != <span class="keyword">null</span> &amp;&amp; allowlistedDataInfoList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        sb.append(Zygote.ALLOWLISTED_DATA_INFO_MAP);</span><br><span class="line">        sb.append(<span class="string">"="</span>);</span><br><span class="line">        <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Pair&lt;String, Long&gt;&gt; entry : allowlistedDataInfoList.entrySet()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (started) &#123;</span><br><span class="line">                sb.append(<span class="string">','</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            started = <span class="keyword">true</span>;</span><br><span class="line">            sb.append(entry.getKey());</span><br><span class="line">            sb.append(<span class="string">','</span>);</span><br><span class="line">            sb.append(entry.getValue().first);</span><br><span class="line">            sb.append(<span class="string">','</span>);</span><br><span class="line">            sb.append(entry.getValue().second);</span><br><span class="line">        &#125;</span><br><span class="line">        argsForZygote.add(sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bindMountAppStorageDirs) &#123;</span><br><span class="line">        argsForZygote.add(Zygote.BIND_MOUNT_APP_STORAGE_DIRS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bindMountAppsData) &#123;</span><br><span class="line">        argsForZygote.add(Zygote.BIND_MOUNT_APP_DATA_DIRS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (disabledCompatChanges != <span class="keyword">null</span> &amp;&amp; disabledCompatChanges.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        sb.append(<span class="string">"--disabled-compat-changes="</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> sz = disabledCompatChanges.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">                sb.append(<span class="string">','</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sb.append(disabledCompatChanges[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        argsForZygote.add(sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    argsForZygote.add(processClass);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (extraArgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Collections.addAll(argsForZygote, extraArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(mLock) &#123;</span><br><span class="line">        <span class="comment">// The USAP pool can not be used if the application will not use the systems graphics</span></span><br><span class="line">        <span class="comment">// driver.  If that driver is requested use the Zygote application start path.</span></span><br><span class="line">        <span class="keyword">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi),</span><br><span class="line">                                            zygotePolicyFlags,</span><br><span class="line">                                            argsForZygote);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法的功能就很简单了，就是将各种参数拼装起来，然后调用<code>zygoteSendArgsAndGetResult</code>方法</p>
<p>我们先看<code>openZygoteSocketIfNeeded</code>这个方法，它返回了一个<code>ZygoteState</code>对象，这个类是对与<code>ZygoteServerSocket</code>建立连接后的封装</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ZygoteState <span class="title">openZygoteSocketIfNeeded</span><span class="params">(String abi)</span> <span class="keyword">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//尝试连接主ZygoteServerSocket</span></span><br><span class="line">        attemptConnectionToPrimaryZygote();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//主zygote进程支持此abi</span></span><br><span class="line">        <span class="keyword">if</span> (primaryZygoteState.matches(abi)) &#123;</span><br><span class="line">            <span class="keyword">return</span> primaryZygoteState;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mZygoteSecondarySocketAddress != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// The primary zygote didn't match. Try the secondary.</span></span><br><span class="line">            <span class="comment">//尝试连接辅ZygoteServerSocket</span></span><br><span class="line">            attemptConnectionToSecondaryZygote();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//辅zygote进程支持此abi</span></span><br><span class="line">            <span class="keyword">if</span> (secondaryZygoteState.matches(abi)) &#123;</span><br><span class="line">                <span class="keyword">return</span> secondaryZygoteState;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(<span class="string">"Error connecting to zygote"</span>, ioe);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(<span class="string">"Unsupported zygote ABI: "</span> + abi);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>attemptConnectionToxxxZygote</code>方法使用<code>LocalSocket</code>进行连接，并返回一个<code>ZygoteState</code>封装对象</p>
<p>我们之前在 <a href="https://juejin.cn/post/7051507161955827720" target="_blank" rel="noopener">Android源码分析 - Zygote进程</a> 中说过，一般，64位的cpu会启动两个<code>zygoto</code>进程，一个64位（主<code>zygote</code>），一个32位（辅<code>zygote</code>）</p>
<p><img src="https://raw.githubusercontent.com/dreamgyf/ImageStorage/master/Android%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%EF%BC%88%E4%B8%AD%EF%BC%89_zygote.png" alt="zygote"></p>
<p>接下来我们看<code>zygoteSendArgsAndGetResult</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Process.<span class="function">ProcessStartResult <span class="title">zygoteSendArgsAndGetResult</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ZygoteState zygoteState, <span class="keyword">int</span> zygotePolicyFlags, @NonNull ArrayList&lt;String&gt; args)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * See com.android.internal.os.ZygoteArguments.parseArgs()</span></span><br><span class="line"><span class="comment">        * Presently the wire format to the zygote process is:</span></span><br><span class="line"><span class="comment">        * a) a count of arguments (argc, in essence)</span></span><br><span class="line"><span class="comment">        * b) a number of newline-separated argument strings equal to count</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * After the zygote process reads these it will write the pid of</span></span><br><span class="line"><span class="comment">        * the child or -1 on failure, followed by boolean to</span></span><br><span class="line"><span class="comment">        * indicate whether a wrapper process was used.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="comment">//构建出符合zygote解析规则的参数（argc + argv）</span></span><br><span class="line">    String msgStr = args.size() + <span class="string">"\n"</span> + String.join(<span class="string">"\n"</span>, args) + <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//USAP机制</span></span><br><span class="line">    <span class="keyword">if</span> (shouldAttemptUsapLaunch(zygotePolicyFlags, args)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> attemptUsapSendArgsAndGetResult(zygoteState, msgStr);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="comment">// If there was an IOException using the USAP pool we will log the error and</span></span><br><span class="line">            <span class="comment">// attempt to start the process through the Zygote.</span></span><br><span class="line">            Log.e(LOG_TAG, <span class="string">"IO Exception while communicating with USAP pool - "</span></span><br><span class="line">                    + ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> attemptZygoteSendArgsAndGetResult(zygoteState, msgStr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>USAP</code>机制我们先跳过，这个方法就做了一件事：拼装参数，然后调用<code>attemptZygoteSendArgsAndGetResult</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Process.<span class="function">ProcessStartResult <span class="title">attemptZygoteSendArgsAndGetResult</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ZygoteState zygoteState, String msgStr)</span> <span class="keyword">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> BufferedWriter zygoteWriter = zygoteState.mZygoteOutputWriter;</span><br><span class="line">        <span class="keyword">final</span> DataInputStream zygoteInputStream = zygoteState.mZygoteInputStream;</span><br><span class="line"></span><br><span class="line">        zygoteWriter.write(msgStr);</span><br><span class="line">        zygoteWriter.flush();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Always read the entire result from the input stream to avoid leaving</span></span><br><span class="line">        <span class="comment">// bytes in the stream for future process starts to accidentally stumble</span></span><br><span class="line">        <span class="comment">// upon.</span></span><br><span class="line">        Process.ProcessStartResult result = <span class="keyword">new</span> Process.ProcessStartResult();</span><br><span class="line">        result.pid = zygoteInputStream.readInt();</span><br><span class="line">        result.usingWrapper = zygoteInputStream.readBoolean();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result.pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(<span class="string">"fork() failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        zygoteState.close();</span><br><span class="line">        Log.e(LOG_TAG, <span class="string">"IO Exception while communicating with Zygote - "</span></span><br><span class="line">                + ex.toString());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法很明显就能看出来，这是一次<code>socket</code>通信发送 -&gt; 接收</p>
<p>具体<code>zygote</code>进程接收到<code>socket</code>后做了什么可以回顾我之前写的文章 <a href="https://juejin.cn/post/7051507161955827720#heading-29" target="_blank" rel="noopener">Android源码分析 - Zygote进程</a></p>
<h2 id="handleProcessStartedLocked"><a href="#handleProcessStartedLocked" class="headerlink" title="handleProcessStartedLocked"></a>handleProcessStartedLocked</h2><p>向<code>zygote</code>发送完<code>socket</code>请求后，<code>zygote</code>开始<code>fork</code>App进程，<code>fork</code>完后会将App进程的<code>pid</code>和<code>usingWrapper</code>信息再通过<code>socket</code>传回<code>system_server</code>，此时程序会继续执行<code>handleProcessStartedLocked</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">handleProcessStartedLocked</span><span class="params">(ProcessRecord app, <span class="keyword">int</span> pid, <span class="keyword">boolean</span> usingWrapper,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> expectedStartSeq, <span class="keyword">boolean</span> procAttached)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//从待启动列表中移除此ProcessRecord</span></span><br><span class="line">    mPendingStarts.remove(expectedStartSeq);</span><br><span class="line">    <span class="keyword">final</span> String reason = isProcStartValidLocked(app, expectedStartSeq);</span><br><span class="line">    <span class="comment">//未通过进程启动验证，杀死进程</span></span><br><span class="line">    <span class="keyword">if</span> (reason != <span class="keyword">null</span>) &#123;</span><br><span class="line">        app.pendingStart = <span class="keyword">false</span>;</span><br><span class="line">        killProcessQuiet(pid);</span><br><span class="line">        Process.killProcessGroup(app.uid, app.pid);</span><br><span class="line">        noteAppKill(app, ApplicationExitInfo.REASON_OTHER,</span><br><span class="line">                ApplicationExitInfo.SUBREASON_INVALID_START, reason);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... <span class="comment">//记录进程启动</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//通知看门狗有进程启动</span></span><br><span class="line">    Watchdog.getInstance().processStarted(app.processName, pid);</span><br><span class="line"></span><br><span class="line">    ... <span class="comment">//记录进程启动</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置ProcessRecord</span></span><br><span class="line">    app.setPid(pid);</span><br><span class="line">    app.setUsingWrapper(usingWrapper);</span><br><span class="line">    app.pendingStart = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//从PidMap中获取未清理的ProcessRecord</span></span><br><span class="line">    ProcessRecord oldApp;</span><br><span class="line">    <span class="keyword">synchronized</span> (mService.mPidsSelfLocked) &#123;</span><br><span class="line">        oldApp = mService.mPidsSelfLocked.get(pid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If there is already an app occupying that pid that hasn't been cleaned up</span></span><br><span class="line">    <span class="comment">//清理ProcessRecord</span></span><br><span class="line">    <span class="keyword">if</span> (oldApp != <span class="keyword">null</span> &amp;&amp; !app.isolated) &#123;</span><br><span class="line">        mService.cleanUpApplicationRecordLocked(oldApp, <span class="keyword">false</span>, <span class="keyword">false</span>, -<span class="number">1</span>,</span><br><span class="line">                <span class="keyword">true</span> <span class="comment">/*replacingPid*/</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将ProcessRecord添加到PidMap中</span></span><br><span class="line">    mService.addPidLocked(app);</span><br><span class="line">    <span class="keyword">synchronized</span> (mService.mPidsSelfLocked) &#123;</span><br><span class="line">        <span class="comment">//attach超时检测</span></span><br><span class="line">        <span class="keyword">if</span> (!procAttached) &#123;</span><br><span class="line">            Message msg = mService.mHandler.obtainMessage(PROC_START_TIMEOUT_MSG);</span><br><span class="line">            msg.obj = app;</span><br><span class="line">            mService.mHandler.sendMessageDelayed(msg, usingWrapper</span><br><span class="line">                    ? PROC_START_TIMEOUT_WITH_WRAPPER : PROC_START_TIMEOUT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法将从<code>zygote</code> <code>fork</code>后得到的信息设置到<code>ProcessRecord</code>中，然后将此<code>ProcessRecord</code>添加到<code>PidMap</code>中（<code>AMS.mPidsSelfLocked</code>），后续当<code>attachApplication</code>时会用到它</p>
<h1 id="ActivityThread"><a href="#ActivityThread" class="headerlink" title="ActivityThread"></a>ActivityThread</h1><p><code>zygote</code>进程将App进程<code>fork</code>出来后，便通过反射调用我们之前设置的<code>entryPoint</code>类的<code>main</code>方法，即<code>android.app.ActivityThread.main(String[] args)</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Install selective syscall interception</span></span><br><span class="line">    <span class="comment">//设置拦截器，拦截部分系统调用自行处理</span></span><br><span class="line">    AndroidOs.install();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CloseGuard defaults to true and can be quite spammy.  We</span></span><br><span class="line">    <span class="comment">// disable it here, but selectively enable it later (via</span></span><br><span class="line">    <span class="comment">// StrictMode) on debug builds, but using DropBox, not logs.</span></span><br><span class="line">    <span class="comment">//资源关闭检测器</span></span><br><span class="line">    CloseGuard.setEnabled(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化用户环境</span></span><br><span class="line">    Environment.initForCurrentUser();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure TrustedCertificateStore looks in the right place for CA certificates</span></span><br><span class="line">    <span class="comment">//设置CA证书搜索位置</span></span><br><span class="line">    <span class="keyword">final</span> File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());</span><br><span class="line">    TrustedCertificateStore.setDefaultUserDirectory(configDir);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call per-process mainline module initialization.</span></span><br><span class="line">    <span class="comment">//初始化主模块各个注册服务</span></span><br><span class="line">    initializeMainlineModules();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//预设进程名</span></span><br><span class="line">    Process.setArgV0(<span class="string">"&lt;pre-initialized&gt;"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//准备Looper</span></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the value for &#123;@link #PROC_START_SEQ_IDENT&#125; if provided on the command line.</span></span><br><span class="line">    <span class="comment">// It will be in the format "seq=114"</span></span><br><span class="line">    <span class="comment">//查找startSeq参数</span></span><br><span class="line">    <span class="keyword">long</span> startSeq = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = args.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (args[i] != <span class="keyword">null</span> &amp;&amp; args[i].startsWith(PROC_START_SEQ_IDENT)) &#123;</span><br><span class="line">                startSeq = Long.parseLong(</span><br><span class="line">                        args[i].substring(PROC_START_SEQ_IDENT.length()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建App进程ActivityThread实例</span></span><br><span class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    thread.attach(<span class="keyword">false</span>, startSeq);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置全局Handler</span></span><br><span class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        sMainThreadHandler = thread.getHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Looper循环处理消息</span></span><br><span class="line">    Looper.loop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>main</code>方法中主要做了两件事，一是启动<code>Looper</code>，循环处理消息，保证进程不会退出，二是实例化<code>ActivityThread</code>并执行<code>attach</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system, <span class="keyword">long</span> startSeq)</span> </span>&#123;</span><br><span class="line">    sCurrentActivityThread = <span class="keyword">this</span>;</span><br><span class="line">    mConfigurationController = <span class="keyword">new</span> ConfigurationController(<span class="keyword">this</span>);</span><br><span class="line">    mSystemThread = system;</span><br><span class="line">    <span class="keyword">if</span> (!system) &#123;    <span class="comment">//非系统ActivityThread</span></span><br><span class="line">        <span class="comment">//预设进程名</span></span><br><span class="line">        android.ddm.DdmHandleAppName.setAppName(<span class="string">"&lt;pre-initialized&gt;"</span>,</span><br><span class="line">                                                UserHandle.myUserId());</span><br><span class="line">        <span class="comment">//处理一些错误异常需要使用ActivityThread，将其传入</span></span><br><span class="line">        RuntimeInit.setApplicationObject(mAppThread.asBinder());</span><br><span class="line">        <span class="comment">//AMS代理binder对象</span></span><br><span class="line">        <span class="keyword">final</span> IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//执行AMS.attachApplication方法</span></span><br><span class="line">            mgr.attachApplication(mAppThread, startSeq);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Watch for getting close to heap limit.</span></span><br><span class="line">        <span class="comment">//每次GC时检测内存，如果内存不足则会尝试释放部分不可见的Activity</span></span><br><span class="line">        BinderInternal.addGcWatcher(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!mSomeActivitiesChanged) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Runtime runtime = Runtime.getRuntime();</span><br><span class="line">                <span class="keyword">long</span> dalvikMax = runtime.maxMemory();</span><br><span class="line">                <span class="keyword">long</span> dalvikUsed = runtime.totalMemory() - runtime.freeMemory();</span><br><span class="line">                <span class="keyword">if</span> (dalvikUsed &gt; ((<span class="number">3</span>*dalvikMax)/<span class="number">4</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_MEMORY_TRIM) Slog.d(TAG, <span class="string">"Dalvik max="</span> + (dalvikMax/<span class="number">1024</span>)</span><br><span class="line">                            + <span class="string">" total="</span> + (runtime.totalMemory()/<span class="number">1024</span>)</span><br><span class="line">                            + <span class="string">" used="</span> + (dalvikUsed/<span class="number">1024</span>));</span><br><span class="line">                    mSomeActivitiesChanged = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        ActivityTaskManager.getService().releaseSomeActivities(mAppThread);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;    <span class="comment">//系统ActivityThread</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理ConfigChanged相关逻辑（屏幕旋转之类）</span></span><br><span class="line">    ViewRootImpl.ConfigChangedCallback configChangedCallback = (Configuration globalConfig) -&gt; &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mResourcesManager) &#123;</span><br><span class="line">            <span class="comment">// We need to apply this change to the resources immediately, because upon returning</span></span><br><span class="line">            <span class="comment">// the view hierarchy will be informed about it.</span></span><br><span class="line">            <span class="keyword">if</span> (mResourcesManager.applyConfigurationToResources(globalConfig,</span><br><span class="line">                    <span class="keyword">null</span> <span class="comment">/* compat */</span>)) &#123;</span><br><span class="line">                mConfigurationController.updateLocaleListFromAppContext(</span><br><span class="line">                        mInitialApplication.getApplicationContext());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// This actually changed the resources! Tell everyone about it.</span></span><br><span class="line">                <span class="keyword">final</span> Configuration updatedConfig =</span><br><span class="line">                        mConfigurationController.updatePendingConfiguration(globalConfig);</span><br><span class="line">                <span class="keyword">if</span> (updatedConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    sendMessage(H.CONFIGURATION_CHANGED, globalConfig);</span><br><span class="line">                    mPendingConfiguration = updatedConfig;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    ViewRootImpl.addConfigCallback(configChangedCallback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而<code>attach</code>方法最重要的一步又是调用了<code>AMS</code>的<code>attachApplication</code>方法</p>
<h1 id="AMS-attachApplication"><a href="#AMS-attachApplication" class="headerlink" title="AMS.attachApplication"></a>AMS.attachApplication</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attachApplication</span><span class="params">(IApplicationThread thread, <span class="keyword">long</span> startSeq)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Invalid application interface"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">        attachApplicationLocked(thread, callingPid, callingUid, startSeq);</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(@NonNull IApplicationThread thread,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> pid, <span class="keyword">int</span> callingUid, <span class="keyword">long</span> startSeq)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the application record that is being attached...  either via</span></span><br><span class="line">    <span class="comment">// the pid if we are running in multiple processes, or just pull the</span></span><br><span class="line">    <span class="comment">// next app record if we are emulating process with anonymous threads.</span></span><br><span class="line">    ProcessRecord app;</span><br><span class="line">    <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line">    <span class="keyword">long</span> bindApplicationTimeMillis;</span><br><span class="line">    <span class="keyword">if</span> (pid != MY_PID &amp;&amp; pid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//通过pid查找PidMap中存在的ProcessRecord</span></span><br><span class="line">        <span class="comment">//对应着handleProcessStartedLocked方法中执行的中的mService.addPidLocked方法</span></span><br><span class="line">        <span class="comment">//在进程同步启动模式下，这里应该是必能取到的</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">            app = mPidsSelfLocked.get(pid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果此ProcessRecord对不上App的ProcessRecord，则将其清理掉</span></span><br><span class="line">        <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; (app.startUid != callingUid || app.startSeq != startSeq)) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// If there is already an app occupying that pid that hasn't been cleaned up</span></span><br><span class="line">            cleanUpApplicationRecordLocked(app, <span class="keyword">false</span>, <span class="keyword">false</span>, -<span class="number">1</span>,</span><br><span class="line">                        <span class="keyword">true</span> <span class="comment">/*replacingPid*/</span>);</span><br><span class="line">            removePidLocked(app);</span><br><span class="line">            app = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        app = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// It's possible that process called attachApplication before we got a chance to</span></span><br><span class="line">    <span class="comment">// update the internal state.</span></span><br><span class="line">    <span class="comment">//在进程异步启动模式下，有可能尚未执行到handleProcessStartedLocked方法</span></span><br><span class="line">    <span class="comment">//所以从PidMap中无法取到相应的ProcessRecord</span></span><br><span class="line">    <span class="comment">//这时候从ProcessList.mPendingStarts这个待启动列表中获取ProcessRecord</span></span><br><span class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span> &amp;&amp; startSeq &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> ProcessRecord pending = mProcessList.mPendingStarts.get(startSeq);</span><br><span class="line">        <span class="keyword">if</span> (pending != <span class="keyword">null</span> &amp;&amp; pending.startUid == callingUid &amp;&amp; pending.startSeq == startSeq</span><br><span class="line">                &amp;&amp; mProcessList.handleProcessStartedLocked(pending, pid, pending</span><br><span class="line">                        .isUsingWrapper(),</span><br><span class="line">                        startSeq, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            app = pending;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//没有找到相应的ProcessRecord，杀死进程</span></span><br><span class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pid &gt; <span class="number">0</span> &amp;&amp; pid != MY_PID) &#123;</span><br><span class="line">            killProcessQuiet(pid);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                thread.scheduleExit();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// Ignore exceptions.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If this application record is still attached to a previous</span></span><br><span class="line">    <span class="comment">// process, clean it up now.</span></span><br><span class="line">    <span class="comment">//如果ProcessRecord绑定了其他的ApplicationThread，则需要清理这个进程</span></span><br><span class="line">    <span class="keyword">if</span> (app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handleAppDiedLocked(app, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String processName = app.processName;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//注册App进程死亡回调</span></span><br><span class="line">        AppDeathRecipient adr = <span class="keyword">new</span> AppDeathRecipient(</span><br><span class="line">                app, pid, thread);</span><br><span class="line">        thread.asBinder().linkToDeath(adr, <span class="number">0</span>);</span><br><span class="line">        app.deathRecipient = adr;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="comment">//如果出现异常则重启进程</span></span><br><span class="line">        app.resetPackageList(mProcessStats);</span><br><span class="line">        mProcessList.startProcessLocked(app,</span><br><span class="line">                <span class="keyword">new</span> HostingRecord(<span class="string">"link fail"</span>, processName),</span><br><span class="line">                ZYGOTE_POLICY_FLAG_EMPTY);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化ProcessRecord各参数</span></span><br><span class="line">    app.curAdj = app.setAdj = app.verifiedAdj = ProcessList.INVALID_ADJ;</span><br><span class="line">    mOomAdjuster.setAttachingSchedGroupLocked(app);</span><br><span class="line">    app.forcingToImportant = <span class="keyword">null</span>;</span><br><span class="line">    updateProcessForegroundLocked(app, <span class="keyword">false</span>, <span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line">    app.hasShownUi = <span class="keyword">false</span>;</span><br><span class="line">    app.setDebugging(<span class="keyword">false</span>);</span><br><span class="line">    app.setCached(<span class="keyword">false</span>);</span><br><span class="line">    app.killedByAm = <span class="keyword">false</span>;</span><br><span class="line">    app.killed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// We carefully use the same state that PackageManager uses for</span></span><br><span class="line">    <span class="comment">// filtering, since we use this flag to decide if we need to install</span></span><br><span class="line">    <span class="comment">// providers when user is unlocked later</span></span><br><span class="line">    app.unlocked = StorageManager.isUserKeyUnlocked(app.userId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//移除之前在handleProcessStartedLocked中设置的attach超时检测</span></span><br><span class="line">    mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//普通App启动肯定在system_server准备完成后，所以此处为true</span></span><br><span class="line">    <span class="keyword">boolean</span> normalMode = mProcessesReady || isAllowedWhileBooting(app.info);</span><br><span class="line">    List&lt;ProviderInfo&gt; providers = normalMode ? generateApplicationProvidersLocked(app) : <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//设置ContentProvider启动超时检测</span></span><br><span class="line">    <span class="keyword">if</span> (providers != <span class="keyword">null</span> &amp;&amp; checkAppInLaunchingProvidersLocked(app)) &#123;</span><br><span class="line">        Message msg = mHandler.obtainMessage(CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG);</span><br><span class="line">        msg.obj = app;</span><br><span class="line">        mHandler.sendMessageDelayed(msg,</span><br><span class="line">                ContentResolver.CONTENT_PROVIDER_PUBLISH_TIMEOUT_MILLIS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> BackupRecord backupTarget = mBackupTargets.get(app.userId);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//对应着开发者模式里的 Select debug app 和 Wait for debugger</span></span><br><span class="line">        <span class="keyword">int</span> testMode = ApplicationThreadConstants.DEBUG_OFF;</span><br><span class="line">        <span class="keyword">if</span> (mDebugApp != <span class="keyword">null</span> &amp;&amp; mDebugApp.equals(processName)) &#123;</span><br><span class="line">            testMode = mWaitForDebugger</span><br><span class="line">                ? ApplicationThreadConstants.DEBUG_WAIT</span><br><span class="line">                : ApplicationThreadConstants.DEBUG_ON;</span><br><span class="line">            app.setDebugging(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (mDebugTransient) &#123;</span><br><span class="line">                mDebugApp = mOrigDebugApp;</span><br><span class="line">                mWaitForDebugger = mOrigWaitForDebugger;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> enableTrackAllocation = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (mTrackAllocationApp != <span class="keyword">null</span> &amp;&amp; mTrackAllocationApp.equals(processName)) &#123;</span><br><span class="line">            enableTrackAllocation = <span class="keyword">true</span>;</span><br><span class="line">            mTrackAllocationApp = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the app is being launched for restore or full backup, set it up specially</span></span><br><span class="line">        <span class="keyword">boolean</span> isRestrictedBackupMode = <span class="keyword">false</span>;</span><br><span class="line">        ... <span class="comment">//备份相关</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ActiveInstrumentation instr;</span><br><span class="line">        ... <span class="comment">//自动化测试相关</span></span><br><span class="line"></span><br><span class="line">        ApplicationInfo appInfo = instr != <span class="keyword">null</span> ? instr.mTargetInfo : app.info;</span><br><span class="line">        app.compat = compatibilityInfoForPackage(appInfo);</span><br><span class="line"></span><br><span class="line">        ProfilerInfo profilerInfo = <span class="keyword">null</span>;</span><br><span class="line">        String preBindAgent = <span class="keyword">null</span>;</span><br><span class="line">        ... <span class="comment">//性能分析相关</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// We deprecated Build.SERIAL and it is not accessible to</span></span><br><span class="line">        <span class="comment">// Instant Apps and target APIs higher than O MR1. Since access to the serial</span></span><br><span class="line">        <span class="comment">// is now behind a permission we push down the value.</span></span><br><span class="line">        <span class="comment">//序列号（Android 8.0后不可再通过Build.SERIAL获取序列号）</span></span><br><span class="line">        <span class="keyword">final</span> String buildSerial = (!appInfo.isInstantApp()</span><br><span class="line">                &amp;&amp; appInfo.targetSdkVersion &lt; Build.VERSION_CODES.P)</span><br><span class="line">                        ? sTheRealBuildSerial : Build.UNKNOWN;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        ... <span class="comment">//自动化测试相关</span></span><br><span class="line">        ... <span class="comment">//性能分析相关</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//debug模式</span></span><br><span class="line">        <span class="keyword">if</span> ((app.info.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>) &#123;</span><br><span class="line">            thread.attachStartupAgents(app.info.dataDir);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ... <span class="comment">//自动填充功能（账号密码等）</span></span><br><span class="line">        ... <span class="comment">//内容捕获相关（ContentCaptureManager）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//自动化测试</span></span><br><span class="line">        <span class="keyword">final</span> ActiveInstrumentation instr2 = app.getActiveInstrumentation();</span><br><span class="line">        <span class="keyword">if</span> (mPlatformCompat != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mPlatformCompat.resetReporting(app.info);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> ProviderInfoList providerList = ProviderInfoList.fromList(providers);</span><br><span class="line">        <span class="comment">//调用ApplicationThread.bindApplication方法</span></span><br><span class="line">        <span class="keyword">if</span> (app.isolatedEntryPoint != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This is an isolated process which should just call an entry point instead of</span></span><br><span class="line">            <span class="comment">// being bound to an application.</span></span><br><span class="line">            thread.runIsolatedEntryPoint(app.isolatedEntryPoint, app.isolatedEntryPointArgs);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (instr2 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            thread.bindApplication(processName, appInfo, providerList,</span><br><span class="line">                    instr2.mClass,</span><br><span class="line">                    profilerInfo, instr2.mArguments,</span><br><span class="line">                    instr2.mWatcher,</span><br><span class="line">                    instr2.mUiAutomationConnection, testMode,</span><br><span class="line">                    mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                    isRestrictedBackupMode || !normalMode, app.isPersistent(),</span><br><span class="line">                    <span class="keyword">new</span> Configuration(app.getWindowProcessController().getConfiguration()),</span><br><span class="line">                    app.compat, getCommonServicesLocked(app.isolated),</span><br><span class="line">                    mCoreSettingsObserver.getCoreSettingsLocked(),</span><br><span class="line">                    buildSerial, autofillOptions, contentCaptureOptions,</span><br><span class="line">                    app.mDisabledCompatChanges);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            thread.bindApplication(processName, appInfo, providerList, <span class="keyword">null</span>, profilerInfo,</span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, testMode,</span><br><span class="line">                    mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                    isRestrictedBackupMode || !normalMode, app.isPersistent(),</span><br><span class="line">                    <span class="keyword">new</span> Configuration(app.getWindowProcessController().getConfiguration()),</span><br><span class="line">                    app.compat, getCommonServicesLocked(app.isolated),</span><br><span class="line">                    mCoreSettingsObserver.getCoreSettingsLocked(),</span><br><span class="line">                    buildSerial, autofillOptions, contentCaptureOptions,</span><br><span class="line">                    app.mDisabledCompatChanges);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make app active after binding application or client may be running requests (e.g</span></span><br><span class="line">        <span class="comment">// starting activities) before it is ready.</span></span><br><span class="line">        <span class="comment">//ProcessRecord保存ApplicationThread代理对象</span></span><br><span class="line">        app.makeActive(thread, mProcessStats);</span><br><span class="line">        <span class="comment">//更新进程使用情况</span></span><br><span class="line">        mProcessList.updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        app.lastRequestedGc = app.lastLowMemory = SystemClock.uptimeMillis();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">//出现错误，杀死进程</span></span><br><span class="line">        app.resetPackageList(mProcessStats);</span><br><span class="line">        app.unlinkDeathRecipient();</span><br><span class="line">        app.kill(<span class="string">"error during bind"</span>, ApplicationExitInfo.REASON_INITIALIZATION_FAILURE, <span class="keyword">true</span>);</span><br><span class="line">        handleAppDiedLocked(app, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove this record from the list of starting applications.</span></span><br><span class="line">    <span class="comment">//从persistent启动列表中移除此ProcessRecord</span></span><br><span class="line">    <span class="comment">//persistent是manifest中application标签下的一个属性</span></span><br><span class="line">    <span class="comment">//设置了此属性代表此App会跟随系统启动而启动</span></span><br><span class="line">    mPersistentStartingProcesses.remove(app);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> badApp = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// See if the top visible activity is waiting to run in this process...</span></span><br><span class="line">    <span class="comment">//检查是否有Activity等待启动</span></span><br><span class="line">    <span class="keyword">if</span> (normalMode) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            didSomething = mAtmInternal.attachApplication(app.getWindowProcessController());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            badApp = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find any services that should be running in this process...</span></span><br><span class="line">    <span class="comment">//检查是否有Services等待启动</span></span><br><span class="line">    <span class="keyword">if</span> (!badApp) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            didSomething |= mServices.attachApplicationLocked(app, processName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            badApp = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if a next-broadcast receiver is in this process...</span></span><br><span class="line">    <span class="comment">//检查是否有广播接收器需要启动</span></span><br><span class="line">    <span class="keyword">if</span> (!badApp &amp;&amp; isPendingBroadcastProcessLocked(pid)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            didSomething |= sendPendingBroadcastsLocked(app);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// If the app died trying to launch the receiver we declare it 'bad'</span></span><br><span class="line">            badApp = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... <span class="comment">//备份相关</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//以上几步发生异常，杀死App进程</span></span><br><span class="line">    <span class="keyword">if</span> (badApp) &#123;</span><br><span class="line">        app.kill(<span class="string">"error during init"</span>, ApplicationExitInfo.REASON_INITIALIZATION_FAILURE, <span class="keyword">true</span>);</span><br><span class="line">        handleAppDiedLocked(app, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!didSomething) &#123;</span><br><span class="line">        <span class="comment">//更新进程OOM等级</span></span><br><span class="line">        updateOomAdjLocked(app, OomAdjuster.OOM_ADJ_REASON_PROCESS_BEGIN);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结一下这个方法主要做了哪些事，首先获取<code>ProcessRecord</code>，然后对其做一些初始化设置，然后调用<code>ApplicaionThread.bindApplication</code>方法，最后分别检查处理<code>Activity</code>、<code>Service</code>和<code>BroadcastReceiver</code>的启动</p>
<h2 id="获取ProcessRecord"><a href="#获取ProcessRecord" class="headerlink" title="获取ProcessRecord"></a>获取ProcessRecord</h2><p>我们看一下这个方法是怎么获取<code>ProcessRecord</code>的，我们先回顾一下之前在<code>startProcessLocked</code>方法的最后，会使用同步或异步的方式启动进程，最终两者都会调用<code>startProcess</code>和<code>handleProcessStartedLocked</code>方法</p>
<h3 id="同步启动进程"><a href="#同步启动进程" class="headerlink" title="同步启动进程"></a>同步启动进程</h3><p>我们回顾一下之前讲到的<code>ActivityManagerInternal.startProcess</code>方法，可以发现它内部使用了<code>synchronized (ActivityManagerService.this)</code>加锁，而<code>AMS.attachApplication</code>方法同样也使用了<code>AMS</code>实例对象加了锁，所以在同步启动进程的情况下，必然会先执行<code>handleProcessStartedLocked</code>方法，再执行<code>attachApplication</code>方法，根据之前所分析的，<code>handleProcessStartedLocked</code>方法会将<code>ProcessRecord</code>存到PidMap中，然后<code>attachApplication</code>方法又会从PidMap中去取，此时取出的<code>ProcessRecord</code>必然不为<code>null</code></p>
<h3 id="异步启动进程"><a href="#异步启动进程" class="headerlink" title="异步启动进程"></a>异步启动进程</h3><p>在异步启动进程的情况下，是通过<code>Handler</code>将启动进程的工作插入到任务队列中，这个任务的执行是不在锁的作用域范围内的，在这个任务内没有对<code>startProcess</code>方法加锁，只对<code>handleProcessStartedLocked</code>方法加了锁，所以这里会有两种情况：</p>
<ul>
<li><p>先执行<code>handleProcessStartedLocked</code>方法，再执行<code>attachApplication</code>方法</p>
<p>  这种情况和同步启动进程的执行顺序是一样的，<code>ProcessRecord</code>获取方式也相同</p>
</li>
<li><p>先执行<code>attachApplication</code>方法，再执行<code>handleProcessStartedLocked</code>方法</p>
<p>  这种情况下，PidMap中取不到相应的<code>ProcessRecord</code>，此时<code>ProcessList.mPendingStarts</code>中还没有将<code>ProcessRecord</code>移除，所以会从<code>mPendingStarts</code>这个启动列表中取出<code>ProcessRecord</code>，然后再调用<code>handleProcessStartedLocked</code>方法，等到<code>attachApplication</code>方法走完，锁释放后，在进入到外部的<code>handleProcessStartedLocked</code>重载方法，这个方法会先判断<code>mPendingStarts</code>中是否还存在对应的<code>ProcessRecord</code>，如果不存在，便会直接返回，保证<code>handleProcessStartedLocked</code>方法只执行一次</p>
</li>
</ul>
<h1 id="ApplicationThread-bindApplication"><a href="#ApplicationThread-bindApplication" class="headerlink" title="ApplicationThread.bindApplication"></a>ApplicationThread.bindApplication</h1><p>接着，我们继续看重点方法<code>ApplicationThread.bindApplication</code></p>
<p><code>ApplicationThread</code>是<code>ActivityThread</code>的一个内部类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bindApplication</span><span class="params">(String processName, ApplicationInfo appInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        ProviderInfoList providerList, ComponentName instrumentationName,</span></span></span><br><span class="line"><span class="function"><span class="params">        ProfilerInfo profilerInfo, Bundle instrumentationArgs,</span></span></span><br><span class="line"><span class="function"><span class="params">        IInstrumentationWatcher instrumentationWatcher,</span></span></span><br><span class="line"><span class="function"><span class="params">        IUiAutomationConnection instrumentationUiConnection, <span class="keyword">int</span> debugMode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> enableBinderTracking, <span class="keyword">boolean</span> trackAllocation,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> isRestrictedBackupMode, <span class="keyword">boolean</span> persistent, Configuration config,</span></span></span><br><span class="line"><span class="function"><span class="params">        CompatibilityInfo compatInfo, Map services, Bundle coreSettings,</span></span></span><br><span class="line"><span class="function"><span class="params">        String buildSerial, AutofillOptions autofillOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">        ContentCaptureOptions contentCaptureOptions, <span class="keyword">long</span>[] disabledCompatChanges)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (services != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Setup the service cache in the ServiceManager</span></span><br><span class="line">        <span class="comment">//初始化通用系统服务缓存</span></span><br><span class="line">        ServiceManager.initServiceCache(services);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setCoreSettings(coreSettings);</span><br><span class="line"></span><br><span class="line">    AppBindData data = <span class="keyword">new</span> AppBindData();</span><br><span class="line">    data.processName = processName;</span><br><span class="line">    data.appInfo = appInfo;</span><br><span class="line">    data.providers = providerList.getList();</span><br><span class="line">    data.instrumentationName = instrumentationName;</span><br><span class="line">    data.instrumentationArgs = instrumentationArgs;</span><br><span class="line">    data.instrumentationWatcher = instrumentationWatcher;</span><br><span class="line">    data.instrumentationUiAutomationConnection = instrumentationUiConnection;</span><br><span class="line">    data.debugMode = debugMode;</span><br><span class="line">    data.enableBinderTracking = enableBinderTracking;</span><br><span class="line">    data.trackAllocation = trackAllocation;</span><br><span class="line">    data.restrictedBackupMode = isRestrictedBackupMode;</span><br><span class="line">    data.persistent = persistent;</span><br><span class="line">    data.config = config;</span><br><span class="line">    data.compatInfo = compatInfo;</span><br><span class="line">    data.initProfilerInfo = profilerInfo;</span><br><span class="line">    data.buildSerial = buildSerial;</span><br><span class="line">    data.autofillOptions = autofillOptions;</span><br><span class="line">    data.contentCaptureOptions = contentCaptureOptions;</span><br><span class="line">    data.disabledCompatChanges = disabledCompatChanges;</span><br><span class="line">    sendMessage(H.BIND_APPLICATION, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法很简单，只是将参数包装成一个<code>AppBindData</code>，然后通过<code>Handler</code>发送消息处理，根据消息的类型，最终会调用<code>ActivityThread.handleBindApplication</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindApplication</span><span class="params">(AppBindData data)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Register the UI Thread as a sensitive thread to the runtime.</span></span><br><span class="line">    <span class="comment">//将UI线程注册成JIT敏感线程</span></span><br><span class="line">    VMRuntime.registerSensitiveThread();</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    mProfiler = <span class="keyword">new</span> Profiler();</span><br><span class="line">    ... <span class="comment">//性能分析相关</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// send up app name; do this *before* waiting for debugger</span></span><br><span class="line">    <span class="comment">//设置进程名</span></span><br><span class="line">    Process.setArgV0(data.processName);</span><br><span class="line">    android.ddm.DdmHandleAppName.setAppName(data.processName,</span><br><span class="line">                                            data.appInfo.packageName,</span><br><span class="line">                                            UserHandle.myUserId());</span><br><span class="line">    VMRuntime.setProcessPackageName(data.appInfo.packageName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Pass data directory path to ART. This is used for caching information and</span></span><br><span class="line">    <span class="comment">// should be set before any application code is loaded.</span></span><br><span class="line">    <span class="comment">//设置进程数据目录</span></span><br><span class="line">    VMRuntime.setProcessDataDirectory(data.appInfo.dataDir);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//性能分析相关</span></span><br><span class="line">    <span class="keyword">if</span> (mProfiler.profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mProfiler.startProfiling();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the app is Honeycomb MR1 or earlier, switch its AsyncTask</span></span><br><span class="line">    <span class="comment">// implementation to use the pool executor.  Normally, we use the</span></span><br><span class="line">    <span class="comment">// serialized executor as the default. This has to happen in the</span></span><br><span class="line">    <span class="comment">// main thread so the main looper is set right.</span></span><br><span class="line">    <span class="comment">//当App的targetSdkVersion小于等于 3.1 (12) 时，AsyncTask使用线程池实现</span></span><br><span class="line">    <span class="keyword">if</span> (data.appInfo.targetSdkVersion &lt;= android.os.Build.VERSION_CODES.HONEYCOMB_MR1) &#123;</span><br><span class="line">        AsyncTask.setDefaultExecutor(AsyncTask.THREAD_POOL_EXECUTOR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Let the util.*Array classes maintain "undefined" for apps targeting Pie or earlier.</span></span><br><span class="line">    <span class="comment">//当App的targetSdkVersion大于等于 10 (29) 时，针对Android SDK提供的容器（SparseArray等）</span></span><br><span class="line">    <span class="comment">//如果index越界，会主动抛ArrayIndexOutOfBoundsException异常</span></span><br><span class="line">    <span class="comment">//（之前数组越界的行为未被定义）</span></span><br><span class="line">    UtilConfig.setThrowExceptionForUpperArrayOutOfBounds(</span><br><span class="line">            data.appInfo.targetSdkVersion &gt;= Build.VERSION_CODES.Q);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当App的targetSdkVersion大于等于 5.0 (21) 时，回收正在使用的Message会抛出异常</span></span><br><span class="line">    Message.updateCheckRecycle(data.appInfo.targetSdkVersion);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prior to P, internal calls to decode Bitmaps used BitmapFactory,</span></span><br><span class="line">    <span class="comment">// which may scale up to account for density. In P, we switched to</span></span><br><span class="line">    <span class="comment">// ImageDecoder, which skips the upscale to save memory. ImageDecoder</span></span><br><span class="line">    <span class="comment">// needs to still scale up in older apps, in case they rely on the</span></span><br><span class="line">    <span class="comment">// size of the Bitmap without considering its density.</span></span><br><span class="line">    ImageDecoder.sApiLevel = data.appInfo.targetSdkVersion;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Before spawning a new process, reset the time zone to be the system time zone.</span></span><br><span class="line"><span class="comment">    * This needs to be done because the system time zone could have changed after the</span></span><br><span class="line"><span class="comment">    * the spawning of this process. Without doing this this process would have the incorrect</span></span><br><span class="line"><span class="comment">    * system time zone.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">//设置时区</span></span><br><span class="line">    TimeZone.setDefault(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Set the LocaleList. This may change once we create the App Context.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    LocaleList.setDefault(data.config.getLocales());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新Configuration</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mResourcesManager) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * Update the system configuration since its preloaded and might not</span></span><br><span class="line"><span class="comment">        * reflect configuration changes. The configuration object passed</span></span><br><span class="line"><span class="comment">        * in AppBindData can be safely assumed to be up to date</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        mResourcesManager.applyConfigurationToResourcesLocked(data.config, data.compatInfo);</span><br><span class="line">        mCurDefaultDisplayDpi = data.config.densityDpi;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This calls mResourcesManager so keep it within the synchronized block.</span></span><br><span class="line">        applyCompatConfiguration(mCurDefaultDisplayDpi);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取LoadedApk</span></span><br><span class="line">    data.info = getPackageInfoNoCheck(data.appInfo, data.compatInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//性能分析器代理JVM（JVMTI）</span></span><br><span class="line">    <span class="keyword">if</span> (agent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handleAttachAgent(agent, data.info);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Switch this process to density compatibility mode if needed.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">//在manifest，supports-screens标签中设置了android:anyDensity</span></span><br><span class="line">    <span class="comment">//详见：https://developer.android.com/guide/topics/manifest/supports-screens-element#any</span></span><br><span class="line">    <span class="keyword">if</span> ((data.appInfo.flags&amp;ApplicationInfo.FLAG_SUPPORTS_SCREEN_DENSITIES)</span><br><span class="line">            == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//指示App包含用于适应任何屏幕密度的资源</span></span><br><span class="line">        mDensityCompatMode = <span class="keyword">true</span>;</span><br><span class="line">        Bitmap.setDefaultDensity(DisplayMetrics.DENSITY_DEFAULT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置默认密度</span></span><br><span class="line">    updateDefaultDensity();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置 12/24 小时时间制 */</span></span><br><span class="line">    <span class="keyword">final</span> String use24HourSetting = mCoreSettings.getString(Settings.System.TIME_12_24);</span><br><span class="line">    Boolean is24Hr = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (use24HourSetting != <span class="keyword">null</span>) &#123;</span><br><span class="line">        is24Hr = <span class="string">"24"</span>.equals(use24HourSetting) ? Boolean.TRUE : Boolean.FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// null : use locale default for 12/24 hour formatting,</span></span><br><span class="line">    <span class="comment">// false : use 12 hour format,</span></span><br><span class="line">    <span class="comment">// true : use 24 hour format.</span></span><br><span class="line">    DateFormat.set24HourTimePref(is24Hr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新view debug属性sDebugViewAttributes</span></span><br><span class="line">    <span class="comment">//设置了这个属性，View将会保存它本身的属性</span></span><br><span class="line">    <span class="comment">//和Layout Inspector相关</span></span><br><span class="line">    updateDebugViewAttributeState();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化默认线程策略</span></span><br><span class="line">    StrictMode.initThreadDefaults(data.appInfo);</span><br><span class="line">    <span class="comment">//初始化默认VM策略</span></span><br><span class="line">    StrictMode.initVmDefaults(data.appInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//debug模式</span></span><br><span class="line">    <span class="keyword">if</span> (data.debugMode != ApplicationThreadConstants.DEBUG_OFF) &#123;</span><br><span class="line">        <span class="comment">// XXX should have option to change the port.</span></span><br><span class="line">        Debug.changeDebugPort(<span class="number">8100</span>);</span><br><span class="line">        <span class="keyword">if</span> (data.debugMode == ApplicationThreadConstants.DEBUG_WAIT) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Application "</span> + data.info.getPackageName()</span><br><span class="line">                    + <span class="string">" is waiting for the debugger on port 8100..."</span>);</span><br><span class="line"></span><br><span class="line">            IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mgr.showWaitingForDebugger(mAppThread, <span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Debug.waitForDebugger();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mgr.showWaitingForDebugger(mAppThread, <span class="keyword">false</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Application "</span> + data.info.getPackageName()</span><br><span class="line">                    + <span class="string">" can be debugged on port 8100..."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow binder tracing, and application-generated systrace messages if we're profileable.</span></span><br><span class="line">    <span class="comment">//性能分析模式</span></span><br><span class="line">    <span class="keyword">boolean</span> isAppProfileable = data.appInfo.isProfileableByShell();</span><br><span class="line">    <span class="comment">//允许应用程序跟踪</span></span><br><span class="line">    Trace.setAppTracingAllowed(isAppProfileable);</span><br><span class="line">    <span class="keyword">if</span> ((isAppProfileable || Build.IS_DEBUGGABLE) &amp;&amp; data.enableBinderTracking) &#123;</span><br><span class="line">        Binder.enableTracing();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize heap profiling.</span></span><br><span class="line">    <span class="comment">//初始化堆分析</span></span><br><span class="line">    <span class="keyword">if</span> (isAppProfileable || Build.IS_DEBUGGABLE) &#123;</span><br><span class="line">        nInitZygoteChildHeapProfiling();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow renderer debugging features if we're debuggable.</span></span><br><span class="line">    <span class="keyword">boolean</span> isAppDebuggable = (data.appInfo.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//开启硬件加速调试功能</span></span><br><span class="line">    HardwareRenderer.setDebuggingEnabled(isAppDebuggable || Build.IS_DEBUGGABLE);</span><br><span class="line">    HardwareRenderer.setPackageName(data.appInfo.packageName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Initialize the default http proxy in this process for the reasons we set the time zone.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">//设置默认HTTP代理</span></span><br><span class="line">    <span class="keyword">final</span> IBinder b = ServiceManager.getService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">    <span class="keyword">if</span> (b != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// In pre-boot mode (doing initial launch to collect password), not</span></span><br><span class="line">        <span class="comment">// all system is up.  This includes the connectivity service, so don't</span></span><br><span class="line">        <span class="comment">// crash if we can't get it.</span></span><br><span class="line">        <span class="keyword">final</span> IConnectivityManager service = IConnectivityManager.Stub.asInterface(b);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Proxy.setHttpProxySystemProperty(service.getProxyForNetwork(<span class="keyword">null</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">            <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instrumentation info affects the class loader, so load it before</span></span><br><span class="line">    <span class="comment">// setting up the app context.</span></span><br><span class="line">    <span class="comment">//准备自动化测试信息</span></span><br><span class="line">    <span class="keyword">final</span> InstrumentationInfo ii;</span><br><span class="line">    <span class="keyword">if</span> (data.instrumentationName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ii = <span class="keyword">new</span> ApplicationPackageManager(</span><br><span class="line">                    <span class="keyword">null</span>, getPackageManager(), getPermissionManager())</span><br><span class="line">                    .getInstrumentationInfo(data.instrumentationName, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Unable to find instrumentation info for: "</span> + data.instrumentationName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Warn of potential ABI mismatches.</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        mInstrumentationPackageName = ii.packageName;</span><br><span class="line">        mInstrumentationAppDir = ii.sourceDir;</span><br><span class="line">        mInstrumentationSplitAppDirs = ii.splitSourceDirs;</span><br><span class="line">        mInstrumentationLibDir = getInstrumentationLibrary(data.appInfo, ii);</span><br><span class="line">        mInstrumentedAppDir = data.info.getAppDir();</span><br><span class="line">        mInstrumentedSplitAppDirs = data.info.getSplitAppDirs();</span><br><span class="line">        mInstrumentedLibDir = data.info.getLibDir();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ii = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建Context</span></span><br><span class="line">    <span class="keyword">final</span> ContextImpl appContext = ContextImpl.createAppContext(<span class="keyword">this</span>, data.info);</span><br><span class="line">    <span class="comment">//更新区域列表</span></span><br><span class="line">    updateLocaleListFromAppContext(appContext,</span><br><span class="line">            mResourcesManager.getConfiguration().getLocales());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!Process.isIsolated()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> oldMask = StrictMode.allowThreadDiskWritesMask();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            setupGraphicsSupport(appContext);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            StrictMode.setThreadPolicyMask(oldMask);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        HardwareRenderer.setIsolatedProcess(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Install the Network Security Config Provider. This must happen before the application</span></span><br><span class="line">    <span class="comment">// code is loaded to prevent issues with instances of TLS objects being created before</span></span><br><span class="line">    <span class="comment">// the provider is installed.</span></span><br><span class="line">    <span class="comment">//网络安全设置</span></span><br><span class="line">    NetworkSecurityConfigProvider.install(appContext);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Continue loading instrumentation.</span></span><br><span class="line">    <span class="keyword">if</span> (ii != <span class="keyword">null</span>) &#123; <span class="comment">//如果设置了自动化测试，实例化指定的自动化测试类</span></span><br><span class="line">        ApplicationInfo instrApp;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            instrApp = getPackageManager().getApplicationInfo(ii.packageName, <span class="number">0</span>,</span><br><span class="line">                    UserHandle.myUserId());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            instrApp = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (instrApp == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instrApp = <span class="keyword">new</span> ApplicationInfo();</span><br><span class="line">        &#125;</span><br><span class="line">        ii.copyTo(instrApp);</span><br><span class="line">        instrApp.initForUser(UserHandle.myUserId());</span><br><span class="line">        <span class="keyword">final</span> LoadedApk pi = getPackageInfo(instrApp, data.compatInfo,</span><br><span class="line">                appContext.getClassLoader(), <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The test context's op package name == the target app's op package name, because</span></span><br><span class="line">        <span class="comment">// the app ops manager checks the op package name against the real calling UID,</span></span><br><span class="line">        <span class="comment">// which is what the target package name is associated with.</span></span><br><span class="line">        <span class="keyword">final</span> ContextImpl instrContext = ContextImpl.createAppContext(<span class="keyword">this</span>, pi,</span><br><span class="line">                appContext.getOpPackageName());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> ClassLoader cl = instrContext.getClassLoader();</span><br><span class="line">            mInstrumentation = (Instrumentation)</span><br><span class="line">                cl.loadClass(data.instrumentationName.getClassName()).newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to instantiate instrumentation "</span></span><br><span class="line">                + data.instrumentationName + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ComponentName component = <span class="keyword">new</span> ComponentName(ii.packageName, ii.name);</span><br><span class="line">        mInstrumentation.init(<span class="keyword">this</span>, instrContext, appContext, component,</span><br><span class="line">                data.instrumentationWatcher, data.instrumentationUiAutomationConnection);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mProfiler.profileFile != <span class="keyword">null</span> &amp;&amp; !ii.handleProfiling</span><br><span class="line">                &amp;&amp; mProfiler.profileFd == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mProfiler.handlingProfiling = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">final</span> File file = <span class="keyword">new</span> File(mProfiler.profileFile);</span><br><span class="line">            file.getParentFile().mkdirs();</span><br><span class="line">            Debug.startMethodTracing(file.toString(), <span class="number">8</span> * <span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//直接实例化Instrumentation</span></span><br><span class="line">        mInstrumentation = <span class="keyword">new</span> Instrumentation();</span><br><span class="line">        mInstrumentation.basicInit(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调整应用可用内存上限</span></span><br><span class="line">    <span class="keyword">if</span> ((data.appInfo.flags&amp;ApplicationInfo.FLAG_LARGE_HEAP) != <span class="number">0</span>) &#123;</span><br><span class="line">        dalvik.system.VMRuntime.getRuntime().clearGrowthLimit();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Small heap, clamp to the current growth limit and let the heap release</span></span><br><span class="line">        <span class="comment">// pages after the growth limit to the non growth limit capacity. b/18387825</span></span><br><span class="line">        dalvik.system.VMRuntime.getRuntime().clampGrowthLimit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow disk access during application and provider setup. This could</span></span><br><span class="line">    <span class="comment">// block processing ordered broadcasts, but later processing would</span></span><br><span class="line">    <span class="comment">// probably end up doing the same disk access.</span></span><br><span class="line">    Application app;</span><br><span class="line">    <span class="keyword">final</span> StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites();</span><br><span class="line">    <span class="keyword">final</span> StrictMode.ThreadPolicy writesAllowedPolicy = StrictMode.getThreadPolicy();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// If the app is being launched for full backup or restore, bring it up in</span></span><br><span class="line">        <span class="comment">// a restricted environment with the base application class.</span></span><br><span class="line">        <span class="comment">//创建Application</span></span><br><span class="line">        app = data.info.makeApplication(data.restrictedBackupMode, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Propagate autofill compat state</span></span><br><span class="line">        <span class="comment">//设置自动填充功能</span></span><br><span class="line">        app.setAutofillOptions(data.autofillOptions);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Propagate Content Capture options</span></span><br><span class="line">        <span class="comment">//设置内容捕获功能</span></span><br><span class="line">        app.setContentCaptureOptions(data.contentCaptureOptions);</span><br><span class="line"></span><br><span class="line">        mInitialApplication = app;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// don't bring up providers in restricted mode; they may depend on the</span></span><br><span class="line">        <span class="comment">// app's custom Application class</span></span><br><span class="line">        <span class="comment">//在非受限模式下启动ContentProvider</span></span><br><span class="line">        <span class="keyword">if</span> (!data.restrictedBackupMode) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ArrayUtils.isEmpty(data.providers)) &#123;</span><br><span class="line">                installContentProviders(app, data.providers);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do this after providers, since instrumentation tests generally start their</span></span><br><span class="line">        <span class="comment">// test thread at this point, and we don't want that racing.</span></span><br><span class="line">        <span class="comment">//执行onCreate方法（默认Instrumentation实现为空方法）</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mInstrumentation.onCreate(data.instrumentationArgs);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//执行Application的onCreate方法</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mInstrumentation.callApplicationOnCreate(app);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// If the app targets &lt; O-MR1, or doesn't change the thread policy</span></span><br><span class="line">        <span class="comment">// during startup, clobber the policy to maintain behavior of b/36951662</span></span><br><span class="line">        <span class="keyword">if</span> (data.appInfo.targetSdkVersion &lt; Build.VERSION_CODES.O_MR1</span><br><span class="line">                || StrictMode.getThreadPolicy().equals(writesAllowedPolicy)) &#123;</span><br><span class="line">            StrictMode.setThreadPolicy(savedPolicy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Preload fonts resources</span></span><br><span class="line">    <span class="comment">//预加载字体资源</span></span><br><span class="line">    FontsContract.setApplicationContextForResources(appContext);</span><br><span class="line">    <span class="keyword">if</span> (!Process.isIsolated()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> ApplicationInfo info =</span><br><span class="line">                    getPackageManager().getApplicationInfo(</span><br><span class="line">                            data.appInfo.packageName,</span><br><span class="line">                            PackageManager.GET_META_DATA <span class="comment">/*flags*/</span>,</span><br><span class="line">                            UserHandle.myUserId());</span><br><span class="line">            <span class="keyword">if</span> (info.metaData != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> preloadedFontsResource = info.metaData.getInt(</span><br><span class="line">                        ApplicationInfo.METADATA_PRELOADED_FONTS, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (preloadedFontsResource != <span class="number">0</span>) &#123;</span><br><span class="line">                    data.info.getResources().preloadFonts(preloadedFontsResource);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法很重要，我们先过一下几个重点部分，然后再按着主线继续往下研究：</p>
<ul>
<li><p><code>Debug</code>、<code>Profiler</code>、<code>Layout Inspector</code></p>
<p><code>Android</code>应用开发的同学对这三样肯定不陌生，在<code>Android Studio</code>中我们可以对App进行调试，性能分析和布局检查，在这个方法中，我们可以找到与这三样相关的一些代码</p>
</li>
<li><p>获取<code>LoadedApk</code></p>
<p><code>LoadedApk</code>是<code>Apk</code>文件在内存中的表示，包含了<code>Apk</code>文件中的代码、资源、组件、<code>manifest</code>等信息</p>
</li>
<li><p>创建<code>Context</code></p>
<p>这里通过<code>ActivityThread</code>和<code>LoadedApk</code>创建出了一个<code>ContextImpl</code></p>
</li>
<li><p>实例化<code>Instrumentation</code></p>
<p>这里和自动化测试相关，如果设置了自动化测试，实例化指定的自动化测试类，否则实例化默认的<code>Instrumentation</code></p>
</li>
<li><p>创建<code>Application</code></p>
<p>这里根据<code>LoadedApk</code>创建出相应的<code>Application</code>，需要注意，这里创建的<code>Application</code>并不与上面创建出的<code>ContextImpl</code>绑定，而是在创建<code>Application</code>的过程中，以同样的参数重新创建了一个<code>ContextImpl</code>，然后调用<code>attachBaseContext</code>方法绑定它</p>
</li>
<li><p>设置<code>HTTP</code>代理</p>
<p>App在启动过程中设置<code>HTTP</code>代理，所以我们在开发过程中使用代理抓包等时候需要注意，设置了代理后需要重启App才会生效</p>
</li>
<li><p>启动<code>ContentProvider</code></p>
<p><code>ContentProvider</code>的启动过程以后会新开文章进行分析，这里只需要知道<code>ContentProvider</code>启动的入口在这就行了</p>
</li>
<li><p>执行<code>Application</code>的<code>onCreate</code>方法</p>
<p>当创建完<code>Application</code>，执行<code>attachBaseContext</code>方法后，便会调用<code>onCreate</code>方法</p>
</li>
</ul>
<p>我们拣重点来看，首先是<code>Application</code>的创建过程</p>
<h2 id="LoadedApk-makeApplication"><a href="#LoadedApk-makeApplication" class="headerlink" title="LoadedApk.makeApplication"></a>LoadedApk.makeApplication</h2><p>在上文的方法中，调用了<code>data.info.makeApplication</code>方法创建<code>Application</code>，其中<code>data.info</code>为<code>LoadedApk</code>类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">makeApplication</span><span class="params">(<span class="keyword">boolean</span> forceDefaultAppClass,</span></span></span><br><span class="line"><span class="function"><span class="params">        Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//如果之前创建过了就可以直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (mApplication != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mApplication;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Application app = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取Application类名（App可以自定义Application这个应该所有开发都知道吧）</span></span><br><span class="line">    <span class="comment">//对应AndroidManifest中application标签下的android:name属性</span></span><br><span class="line">    String appClass = mApplicationInfo.className;</span><br><span class="line">    <span class="comment">//没有设置自定义Application或强制使用默认Application的情况下，使用默认Application</span></span><br><span class="line">    <span class="keyword">if</span> (forceDefaultAppClass || (appClass == <span class="keyword">null</span>)) &#123;</span><br><span class="line">        appClass = <span class="string">"android.app.Application"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//初始化ContextClassLoader</span></span><br><span class="line">        <span class="keyword">final</span> java.lang.ClassLoader cl = getClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (!mPackageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">            initializeJavaContextClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Rewrite the R 'constants' for all library apks.</span></span><br><span class="line">        <span class="comment">//Android共享库资源ID动态映射</span></span><br><span class="line">        SparseArray&lt;String&gt; packageIdentifiers = getAssets().getAssignedPackageIdentifiers(</span><br><span class="line">                <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, n = packageIdentifiers.size(); i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> id = packageIdentifiers.keyAt(i);</span><br><span class="line">            <span class="keyword">if</span> (id == <span class="number">0x01</span> || id == <span class="number">0x7f</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rewriteRValues(cl, packageIdentifiers.valueAt(i), id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建Context</span></span><br><span class="line">        ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, <span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// The network security config needs to be aware of multiple</span></span><br><span class="line">        <span class="comment">// applications in the same process to handle discrepancies</span></span><br><span class="line">        <span class="comment">//网络安全设置</span></span><br><span class="line">        NetworkSecurityConfigProvider.handleNewApplication(appContext);</span><br><span class="line">        <span class="comment">//创建Application</span></span><br><span class="line">        app = mActivityThread.mInstrumentation.newApplication(</span><br><span class="line">                cl, appClass, appContext);</span><br><span class="line">        appContext.setOuterContext(app);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//加入Application列表中（多个App可以运行在同一个进程中）</span></span><br><span class="line">    mActivityThread.mAllApplications.add(app);</span><br><span class="line">    mApplication = app;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (instrumentation != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//调用Application的OnCreate方法</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            instrumentation.callApplicationOnCreate(app);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法首先尝试取成员变量<code>mApplication</code>，如果不为<code>null</code>，说明曾创建过，直接返回就可以了</p>
<p>然后再去获取<code>Application</code>类名，默认为<code>android.app.Application</code>，开发可以通过设置<code>AndroidManifest</code>中<code>application</code>标签下的<code>android:name</code>属性来选择创建自定义的<code>Application</code></p>
<p>然后对共享库资源ID做动态映射，关于这部分感兴趣的同学可以去搜索<code>Android Dynamic Reference</code></p>
<p>接着创建出<code>ContextImpl</code>作为<code>Application</code>的<code>BaseContext</code>，<code>Application</code>继承自<code>ContextWrapper</code>，而<code>ContextWrapper</code>又继承自<code>Context</code>，<code>ContextWrapper</code>是对<code>Context</code>的包装，里面有一个<code>mBase</code>成员变量，调用任何方法实际上都是调用<code>mBase</code>这个实例的方法，在<code>Application</code>创建后会调用<code>attachBaseContext</code>将刚刚创建出来的<code>ContextImpl</code>赋值给<code>mBase</code>成员变量，所以调用<code>Application</code>中的任何<code>Context</code>方法，实际上最终都是调用<code>ContextImpl</code>的方法</p>
<p>然后创建<code>Application</code>，并将其设置成<code>ContextImpl</code>的<code>OuterContext</code></p>
<p>最后将创建好的<code>Application</code>设置给成员变量<code>mApplication</code>，方便以后获取，然后将其再添加到<code>mActivityThread.mAllApplications</code>列表中，返回</p>
<h3 id="ContextImpl-createAppContext"><a href="#ContextImpl-createAppContext" class="headerlink" title="ContextImpl.createAppContext"></a>ContextImpl.createAppContext</h3><p>我们简单看一下<code>ContextImpl</code>的创建，对于不同的组件，创建<code>ContextImpl</code>对象的方法不同，比如说<code>Activity</code>的<code>Context</code>是通过<code>createActivityContext</code>方法创建的，我们这里是通过<code>createAppContext</code>创建<code>Application</code>的<code>Context</code>的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> ContextImpl <span class="title">createAppContext</span><span class="params">(ActivityThread mainThread, LoadedApk packageInfo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> createAppContext(mainThread, packageInfo, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> ContextImpl <span class="title">createAppContext</span><span class="params">(ActivityThread mainThread, LoadedApk packageInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        String opPackageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (packageInfo == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"packageInfo"</span>);</span><br><span class="line">    ContextImpl context = <span class="keyword">new</span> ContextImpl(<span class="keyword">null</span>, mainThread, packageInfo,</span><br><span class="line">        ContextParams.EMPTY, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, opPackageName);</span><br><span class="line">    context.setResources(packageInfo.getResources());</span><br><span class="line">    <span class="comment">//检查android.permission.STATUS_BAR_SERVICE权限</span></span><br><span class="line">    context.mContextType = isSystemOrSystemUI(context) ? CONTEXT_TYPE_SYSTEM_OR_SYSTEM_UI</span><br><span class="line">            : CONTEXT_TYPE_NON_UI;</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单看看就好，我们的重点不在这里，这个方法实例化了一个<code>ContextImpl</code>对象，然后通过<code>ResourcesManager</code>获得<code>Apk</code>的<code>Resource</code>，将其设置到<code>ContextImpl</code>中</p>
<h3 id="Instrumentation-newApplication"><a href="#Instrumentation-newApplication" class="headerlink" title="Instrumentation.newApplication"></a>Instrumentation.newApplication</h3><p>接着我们来看一下<code>Application</code>是怎么创建的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">newApplication</span><span class="params">(ClassLoader cl, String className, Context context)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException, </span></span><br><span class="line"><span class="function">        ClassNotFoundException </span>&#123;</span><br><span class="line">    Application app = getFactory(context.getPackageName())</span><br><span class="line">            .instantiateApplication(cl, className);</span><br><span class="line">    app.attach(context);</span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里，<code>getFactory</code>方法返回的是一个<code>AppComponentFactory</code>对象，这个类是在<code>Android 9</code>之后加入的，它包括一个实例化<code>ClassLoader</code>的方法，一个实例化<code>Application</code>的方法和四个实例化四大组件的方法</p>
<p>我们可以在<code>AndroidManifest</code>中设置<code>application</code>标签的<code>android:appComponentFactory</code>属性，将其设置成我们自定义的<code>AppComponentFactory</code>，从而进行一些监控或别的操作</p>
<p>我们看一下<code>AppComponentFactory</code>的默认实现是怎样的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@NonNull</span> <span class="function">Application <span class="title">instantiateApplication</span><span class="params">(@NonNull ClassLoader cl,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull String className)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (Application) cl.loadClass(className).newInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到非常简单，就是通过<code>className</code>反射实例化出一个<code>Application</code></p>
<p>接着我们回到<code>newApplication</code>方法中，我们对新创建的<code>Application</code>调用了<code>attach</code>方法去绑定<code>ContextImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* package */</span> <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    attachBaseContext(context);</span><br><span class="line">    mLoadedApk = ContextImpl.getImpl(context).mPackageInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的<code>attachBaseContext</code>调用的是父类<code>ContextWrapper</code>中的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mBase != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Base context already set"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mBase = base;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，就是将<code>ContextImpl</code>赋值给<code>ContextWrapper</code>中的<code>mBase</code>赋值，这样后面对<code>Application</code>调用<code>Context</code>的方法，实际上就是代理给这个<code>mBase</code>去执行了</p>
<p>到这一步位置，<code>Application</code>就创建完成了，接下来在<code>ActivityThread.handleBindApplication</code>方法中，还有一步重要操作，就是调用<code>Application</code>的<code>onCreate</code>方法</p>
<p>这里是借助了<code>Instrumentation.callApplicationOnCreate</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callApplicationOnCreate</span><span class="params">(Application app)</span> </span>&#123;</span><br><span class="line">    app.onCreate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就是简简单单直接调用了<code>Application</code>的<code>onCreate</code>方法</p>
<h1 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h1><p>到这里为止，整个<code>Application</code>的工作都做完了，接下来还剩检查并启动<code>Activity</code>、<code>Service</code>和<code>BroadcastReceiver</code>，这些内容就放到下一篇再讲吧</p>
<p>话说回来有点惭愧，这篇文章距离上一篇间隔了三个月，最近在忙一些别的项目，这篇文章断断续续写了一个多月才憋出来，感谢大家的支持，在这里我厚着脸皮<strong>求点赞求收藏</strong>，大家的支持就是我创作的动力</p>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android%E6%BA%90%E7%A0%81/">Android源码</a><a class="post-meta__tags" href="/tags/ActivityThread/">ActivityThread</a><a class="post-meta__tags" href="/tags/ActivityManagerService/">ActivityManagerService</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/12/19/android/aosp/Android%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%EF%BC%88%E4%B8%8B%EF%BC%89/"><i class="fa fa-chevron-left">  </i><span>Android源码分析 - Activity启动流程（下）</span></a></div><div class="next-post pull-right"><a href="/2022/09/14/android/compile/Android%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91OpenCV+FFmpeg+x264%E7%9A%84%E8%89%B0%E9%9A%BE%E5%8E%86%E7%A8%8B/"><span>Android交叉编译OpenCV+FFmpeg+x264的艰难历程</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(/images/background.jpeg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2025 By dreamgyf</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>